<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; padding: 20px; text-align: center; background-color: #f4f7f6; }
        .container-box { max-width: 700px; margin: 0 auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); }
        h1 { font-size: 32px; color: #d9534f; margin-bottom: 20px; }
        button { margin: 10px 5px; padding: 12px 24px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; background-color: #eee; transition:0.3s;}
        button.primary { background-color: #28a745; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-control { padding: 10px; width: 100%; max-width: 400px; margin-top: 5px; text-align: center; font-size: 16px; border:1px solid #ccc; border-radius:6px;}
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); color: white; display: none; justify-content: center; align-items: center; z-index: 1000; }
        #certificate { border: 5px solid #333; padding: 40px; margin: 20px auto; display: none; }
    </style>
</head>
<body>
    <div id="loadingOverlay"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2></div>
    <div class="container-box">
        <h1>E-Simulator (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï/‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç)</h1>
        
        <div id="regSec">
            <input type="text" id="uName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"><br>
            <select id="uGroup" class="form-control">
                <option value="Nursery">Nursery</option>
                <option value="NewTSRs">NewTSRs</option>
            </select><br>
            <button id="startBtn" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>

        <div id="testSec" style="display:none;">
            <div id="s1">
                <h2>1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</h2>
                <p id="st1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠...</p>
                <button id="rec1" class="primary">üéôÔ∏è ‡∏û‡∏π‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß</button>
                <button id="next1" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
            <div id="s2" style="display:none;">
                <h2>2. ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h2>
                <p id="st2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠...</p>
                <button id="playQ">üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
                <button id="rec2" disabled>üéôÔ∏è ‡∏ï‡∏≠‡∏ö</button>
                <button id="next2" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
            <div id="s3" style="display:none;">
                <h2>3. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢/‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</h2>
                <p id="st3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠...</p>
                <button id="rec3Close">üéôÔ∏è ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <button id="rec3Rep" disabled>üéôÔ∏è ‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button id="next3" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
            <div id="s4" style="display:none;">
                <h2>4. ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h2>
                <p id="st4">‡∏£‡∏≠...</p>
                <button id="rec4">üéôÔ∏è ‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
                <button id="next4" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
            <div id="s5" style="display:none;">
                <h2>5. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                <p id="st5">‡∏£‡∏≠...</p>
                <button id="rec5">üéôÔ∏è ‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button id="saveAll" disabled class="primary">üíæ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const sb = createClient('https://wzwyotzzxycqfwercakh.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno');
        
        const PRODUCT = localStorage.getItem('roleplaySelectedProduct') || 'life1';
        let mediaRec, chunks=[], turn=0, qRound=0, cRound=0, hIdx=0, aRound=0;
        let dataS1=[], dataS2=[], dataS3=[], dataS4=[], dataS5=[], config={};
        let recordings=[];

        // Data Fetching with .overlaps
        async function loadData() {
            document.getElementById('loadingOverlay').style.display='flex';
            const filter = [PRODUCT, 'all']; // Array Filter
            
            // Config
            const {data:cfg} = await sb.from('difficulty_config').select('*');
            config = cfg.find(c => c.difficulty_level === 'easy') || cfg[0];

            // Content
            const {data:d1} = await sb.from('customer_replies_s1').select('*').overlaps('product_type', filter).order('turn_index');
            dataS1 = d1;
            const {data:d2} = await sb.from('questions_s2').select('*').overlaps('product_type', filter).order('q_index');
            dataS2 = d2;
            const {data:d3} = await sb.from('objections_s3').select('*').overlaps('product_type', filter).order('ob_index');
            dataS3 = d3;
            const {data:d4} = await sb.from('health_questions_s4').select('*').overlaps('product_type', filter).order('q_index');
            dataS4 = d4;
            const {data:d5} = await sb.from('scripts_s5').select('*').overlaps('product_type', filter).order('step_index');
            dataS5 = d5;
            
            document.getElementById('loadingOverlay').style.display='none';
            checkAutoStart();
        }

        function checkAutoStart() {
            const u = localStorage.getItem('roleplayUserData');
            if(u) {
                const user = JSON.parse(u);
                document.getElementById('uName').value = user.fullName;
                // Auto Click
                document.getElementById('startBtn').click();
            }
        }

        // Logic
        document.getElementById('startBtn').onclick = () => {
            document.getElementById('regSec').style.display='none';
            document.getElementById('testSec').style.display='block';
            document.getElementById('st1').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô 1";
        };

        // Section 1
        document.getElementById('rec1').onclick = async () => {
            await record(1);
            turn++;
            if(turn < config.max_s1 && dataS1[turn-1]) {
                new Audio(dataS1[turn-1].audio_url).play();
                document.getElementById('st1').innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì...";
            } else {
                document.getElementById('next1').disabled=false;
                document.getElementById('rec1').disabled=true;
            }
        };
        document.getElementById('next1').onclick = () => {
            document.getElementById('s1').style.display='none';
            document.getElementById('s2').style.display='block';
        };

        // Section 2
        document.getElementById('playQ').onclick = () => {
             qRound++;
             if(dataS2[qRound-1]) {
                 const a = new Audio(dataS2[qRound-1].audio_url);
                 a.play();
                 a.onended = () => document.getElementById('rec2').disabled=false;
             } else {
                 document.getElementById('next2').disabled=false;
             }
        };
        document.getElementById('rec2').onclick = async () => {
             await record(2);
             document.getElementById('rec2').disabled=true;
        };
        document.getElementById('next2').onclick = () => {
            document.getElementById('s2').style.display='none';
            document.getElementById('s3').style.display='block';
        };

        // Section 3
        document.getElementById('rec3Close').onclick = async () => { await record(3); document.getElementById('rec3Close').disabled=true; playObj(); };
        document.getElementById('rec3Rep').onclick = async () => { await record(3); document.getElementById('rec3Rep').disabled=true; playObj(); };
        function playObj() {
            cRound++;
            if(cRound <= config.max_s3 && dataS3[cRound-1]) {
                const a = new Audio(dataS3[cRound-1].audio_url);
                a.play();
                a.onended = () => document.getElementById('rec3Rep').disabled=false;
            } else {
                document.getElementById('next3').disabled=false;
            }
        }
        document.getElementById('next3').onclick = () => {
            document.getElementById('s3').style.display='none';
            // Check if S4 needed
            if(config.max_s4 > 0 && dataS4.length > 0) document.getElementById('s4').style.display='block';
            else document.getElementById('s5').style.display='block';
        };

        // Section 4
        document.getElementById('rec4').onclick = async () => {
            await record(4);
            hIdx++;
            if(hIdx >= config.max_s4) {
                 document.getElementById('next4').disabled=false;
                 document.getElementById('rec4').disabled=true;
            }
        };
        document.getElementById('next4').onclick = () => {
            document.getElementById('s4').style.display='none';
            document.getElementById('s5').style.display='block';
        };

        // Section 5
        document.getElementById('rec5').onclick = async () => {
            await record(5);
            aRound++;
            if(aRound >= config.max_s5) {
                document.getElementById('rec5').disabled=true;
                document.getElementById('saveAll').disabled=false;
            } else {
                if(dataS5[aRound-1]) new Audio(dataS5[aRound-1].customer_audio_url).play();
            }
        };

        document.getElementById('saveAll').onclick = () => {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! (‡∏à‡∏≥‡∏•‡∏≠‡∏á)");
            window.location.href = 'index.html';
        };

        async function record(part) {
            // Mock Recorder
            return new Promise(r => setTimeout(r, 1000));
        }

        loadData();
    </script>
</body>
</html>
