<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Admin Panel: Health Simulator Content</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1000px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
            margin: 0 auto; 
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 { 
            text-align: center;
            color: #007bff;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        h2 { color: #333; margin-top: 25px; border-bottom: 1px solid #ddd; padding-bottom: 5px;}
        .data-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .item-row {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #fff;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        textarea, input[type="text"], input[type="number"] {
            width: 98%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            margin-top: 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: background-color 0.3s;
            background-color: #28a745;
            color: white;
        }
        button:hover {
            background-color: #218838;
        }
        .audio-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .audio-url-display {
            font-size: 12px;
            word-break: break-all;
            color: #666;
            flex-grow: 1;
        }
        .upload-area {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #007bff;
            border-radius: 4px;
        }
        .loading-text {
            color: orange;
            font-weight: bold;
        }
        .success-text {
            color: green;
            font-weight: bold;
        }
        .error-text {
            color: red;
            font-weight: bold;
        }
        .flex-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }
        .flex-col {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üî• Admin Panel: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h1>
    <p class="loading-text" id="statusMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase...</p>
    
    <div id="configSection" class="data-section" style="display: none;">
        <h2>0. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö (Difficulty Configuration)</h2>
        <div id="configList">
            </div>
        <button onclick="updateConfig()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="s1Section" class="data-section" style="display: none;">
        <h2>1. ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (S1 - Customer Replies)</h2>
        <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô: (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô FINALE)</p>
        <div id="s1List">
            </div>
    </div>
    
    <div class="flex-row">
        <div id="s2Section" class="data-section flex-col" style="display: none;">
            <h2>2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S2)</h2>
            <div id="s2List">
                </div>
        </div>

        <div id="s3Section" class="data-section flex-col" style="display: none;">
            <h2>3. ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (S3)</h2>
            <div id="s3List">
                </div>
        </div>
    </div>

    <div id="healthQuestionsSection" class="data-section" style="display: none;">
        <h2>4. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å (S4 - Q1 ‡∏ñ‡∏∂‡∏á Q5)</h2>
        <div id="q4List">
            </div>
        <button onclick="updateHealthQuestions()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        
        <h3>4.1 ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà" (Q4 Yes Trigger)</h3>
        <p>URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Q4) ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</p>
        <div class="item-row">
            <label>URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
            <div class="audio-url-display" id="yesTriggerUrlDisplay"></div>
            <audio id="yesTriggerAudio" controls></audio>
            
            <div class="upload-area">
                <label for="yesTriggerFileInput">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (.webm/MP3):</label>
                <input type="file" id="yesTriggerFileInput" accept="audio/*">
                <button onclick="uploadYesTriggerAudio()">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL</button>
                <p class="loading-text" id="uploadStatus"></p>
            </div>
        </div>
        
        <h3>4.2 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (S4 Follow-up Names)</h3>
        <div id="fuNamesList">
            </div>
        <button onclick="updateFollowUpNames()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        
        <h3>4.3 ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (F1 ‡∏ñ‡∏∂‡∏á F5)</h3>
        <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</p>
        <div id="fuRepliesList">
            </div>
    </div>
    
    <div id="s5Section" class="data-section" style="display: none;">
        <h2>5. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S5)</h2>
        <div id="s5List">
            </div>
        <button onclick="updateS5Names()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>

</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

    // ** 1. Supabase Configuration (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö index1.html) **
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Global Data Stores
    let configData = [];
    let s1FilesData = [];
    let s2QuestionsData = [];
    let s3ObjectionsData = [];
    let healthQuestionsData = [];
    let followUpNamesData = [];
    let followUpRepliesData = [];
    let s5StepsData = [];
    let yesTriggerQ = null;

    const statusElement = document.getElementById('statusMessage');

    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (READ) ---
    const fetchAllData = async () => {
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

        try {
            // 2.0 Config
            const { data: cData, error: cError } = await supabase.from('difficulty_config').select('*');
            if (cError) throw cError;
            configData = cData;

            // 2.1 S1
            const { data: s1Data, error: s1Error } = await supabase.from('customer_replies_s1').select('*').order('turn_index', { ascending: true });
            if (s1Error) throw s1Error;
            s1FilesData = s1Data;
            
            // 2.2 S2
            const { data: s2Data, error: s2Error } = await supabase.from('questions_s2').select('*').order('q_index', { ascending: true });
            if (s2Error) throw s2Error;
            s2QuestionsData = s2Data;

            // 2.3 S3
            const { data: s3Data, error: s3Error } = await supabase.from('objections_s3').select('*').order('ob_index', { ascending: true });
            if (s3Error) throw s3Error;
            s3ObjectionsData = s3Data;
            
            // 2.4 S4 - Health Questions
            const { data: qData, error: qError } = await supabase.from('health_questions_s4').select('*').order('q_index', { ascending: true });
            if (qError) throw qError;
            healthQuestionsData = qData;
            yesTriggerQ = qData.find(q => q.is_yes_trigger) || null;
            
            // 2.5 S4 - Follow Up Names
            const { data: fuData, error: fuError } = await supabase.from('s4_follow_up_names').select('*').order('step_index', { ascending: true });
            if (fuError) throw fuError;
            followUpNamesData = fuData;
            
            // 2.6 S4 - Follow Up Replies
            const { data: furData, error: furError } = await supabase.from('s4_follow_up_replies').select('*').order('step_index', { ascending: true });
            if (furError) throw furError;
            followUpRepliesData = furData;

            // 2.7 S5
            const { data: s5Data, error: s5Error } = await supabase.from('scripts_s5').select('*').order('step_index', { ascending: true });
            if (s5Error) throw s5Error;
            s5StepsData = s5Data;

            renderUI();
            statusElement.className = 'success-text';
            statusElement.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';

        } catch (err) {
            console.error('Fetch error:', err);
            statusElement.className = 'error-text';
            statusElement.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${err.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS ‡πÅ‡∏•‡∏∞ Column Names.`;
        }
    };

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Section ---
    const createAudioUploaderHTML = (id, table, column, index_col, index_val) => {
        return `
            <div class="upload-area">
                <label for="${id}_file_input">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (.webm/MP3):</label>
                <input type="file" id="${id}_file_input" accept="audio/*">
                <button onclick="uploadAudio('${id}_file_input', '${table}', '${column}', '${index_col}', '${index_val}', '${id}_status')">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL</button>
                <p class="loading-text" id="${id}_status"></p>
            </div>
        `;
    };

    const renderConfig = () => {
        const list = document.getElementById('configList');
        list.innerHTML = '';
        configData.forEach(c => {
            list.innerHTML += `
                <div class="item-row" data-id="${c.id}">
                    <strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${c.difficulty_level.toUpperCase()}</strong>
                    <div class="flex-row" style="gap: 10px;">
                        <div class="flex-col">S1 (‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß): <input type="number" id="c_s1_${c.id}" value="${c.max_s1}"></div>
                        <div class="flex-col">S2 (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°): <input type="number" id="c_s2_${c.id}" value="${c.max_s2}"></div>
                        <div class="flex-col">S3 (‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á): <input type="number" id="c_s3_${c.id}" value="${c.max_s3}"></div>
                        <div class="flex-col">S4 (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û): <input type="number" id="c_s4_${c.id}" value="${c.max_s4}"></div>
                        <div class="flex-col">S5 (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô): <input type="number" id="c_s5_${c.id}" value="${c.max_s5}"></div>
                    </div>
                </div>
            `;
        });
        document.getElementById('configSection').style.display = 'block';
    };

    const renderS1 = () => {
        const list = document.getElementById('s1List');
        list.innerHTML = '';
        s1FilesData.forEach(f => {
            const isFinale = f.is_finale ? ' (FINALE)' : '';
            const uploadId = `s1_upload_${f.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${f.id}">
                    <strong>Turn ${f.turn_index}${isFinale}:</strong>
                    <div class="audio-control">
                        <div class="audio-url-display">${f.audio_url}</div>
                        <audio src="${f.audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'customer_replies_s1', 'audio_url', 'id', f.id)}
                </div>
            `;
        });
        document.getElementById('s1Section').style.display = 'block';
    };

    const renderS2 = () => {
        const list = document.getElementById('s2List');
        list.innerHTML = '';
        s2QuestionsData.forEach(q => {
            const uploadId = `s2_upload_${q.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${q.id}">
                    <strong>Q${q.q_index}</strong>
                    <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</label>
                    <textarea id="s2_text_${q.id}" rows="2">${q.q_text || ''}</textarea>
                    <div class="audio-control">
                        <div class="audio-url-display">${q.audio_url}</div>
                        <audio src="${q.audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'questions_s2', 'audio_url', 'id', q.id)}
                </div>
            `;
        });
        document.getElementById('s2Section').style.display = 'block';
    };

    const renderS3 = () => {
        const list = document.getElementById('s3List');
        list.innerHTML = '';
        s3ObjectionsData.forEach(o => {
            const uploadId = `s3_upload_${o.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${o.id}">
                    <strong>Objection ${o.ob_index}</strong>
                    <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á:</label>
                    <textarea id="s3_text_${o.id}" rows="2">${o.ob_text || ''}</textarea>
                    <div class="audio-control">
                        <div class="audio-url-display">${o.audio_url}</div>
                        <audio src="${o.audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'objections_s3', 'audio_url', 'id', o.id)}
                </div>
            `;
        });
        document.getElementById('s3Section').style.display = 'block';
    };
    
    // S4 (Q4 - Yes Trigger Audio) ‡∏ñ‡∏π‡∏Å‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô renderUI ‡∏´‡∏•‡∏±‡∏Å
    const renderFUReplies = () => {
        const list = document.getElementById('fuRepliesList');
        list.innerHTML = '';
        followUpRepliesData.forEach(r => {
            const uploadId = `fu_reply_upload_${r.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${r.id}">
                    <strong>F${r.step_index}: (${r.disease_name || '‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'})</strong>
                    <div class="audio-control">
                        <div class="audio-url-display">${r.customer_audio_url}</div>
                        <audio src="${r.customer_audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 's4_follow_up_replies', 'customer_audio_url', 'id', r.id)}
                </div>
            `;
        });
    };

    const renderS5 = () => {
        const list = document.getElementById('s5List');
        list.innerHTML = '';
        s5StepsData.forEach(s => {
            const uploadId = `s5_upload_${s.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${s.id}">
                    <strong>Step ${s.step_index}</strong>
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô/‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå:</label>
                    <textarea id="s5_name_${s.id}" rows="2">${s.step_name}</textarea>
                    <div class="audio-control">
                        <div class="audio-url-display">${s.customer_audio_url}</div>
                        <audio src="${s.customer_audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'scripts_s5', 'customer_audio_url', 'id', s.id)}
                </div>
            `;
        });
        document.getElementById('s5Section').style.display = 'block';
    };

    const renderUI = () => {
        // Render All Sections
        renderConfig();
        renderS1();
        renderS2();
        renderS3();
        renderFUReplies(); // 4.3
        renderS5();
        
        // 4.0/4.1/4.2 (Health Qs & Follow-up Names) (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
        const q4List = document.getElementById('q4List');
        q4List.innerHTML = '';
        healthQuestionsData.forEach(q => {
            const isTrigger = q.is_yes_trigger ? ' (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô)' : '';
            q4List.innerHTML += `
                <div class="item-row" data-id="${q.id}">
                    <strong>Q${q.q_index}${isTrigger}:</strong>
                    <textarea id="q4_text_${q.id}" rows="3">${q.q_text}</textarea>
                </div>
            `;
        });
        const fuNamesList = document.getElementById('fuNamesList');
        fuNamesList.innerHTML = '';
        followUpNamesData.forEach(q => {
            fuNamesList.innerHTML += `
                <div class="item-row" data-id="${q.id}">
                    <strong>Step ${q.step_index}:</strong>
                    <input type="text" id="fu_name_${q.id}" value="${q.step_name}">
                </div>
            `;
        });
        const yesTriggerUrlDisplay = document.getElementById('yesTriggerUrlDisplay');
        const yesTriggerAudio = document.getElementById('yesTriggerAudio');
        if (yesTriggerQ) {
            yesTriggerUrlDisplay.textContent = yesTriggerQ.yes_trigger_url || 'N/A';
            yesTriggerAudio.src = yesTriggerQ.yes_trigger_url;
            yesTriggerAudio.load();
        } else {
            yesTriggerUrlDisplay.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Yes Trigger (is_yes_trigger=true)';
        }

        document.getElementById('healthQuestionsSection').style.display = 'block';
    };

    // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (UPDATE TEXT) ---

    window.updateConfig = async () => {
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö...';
        statusElement.className = 'loading-text';
        
        for (const c of configData) {
            const updates = {
                max_s1: parseInt(document.getElementById(`c_s1_${c.id}`).value),
                max_s2: parseInt(document.getElementById(`c_s2_${c.id}`).value),
                max_s3: parseInt(document.getElementById(`c_s3_${c.id}`).value),
                max_s4: parseInt(document.getElementById(`c_s4_${c.id}`).value),
                max_s5: parseInt(document.getElementById(`c_s5_${c.id}`).value),
            };
            const { error } = await supabase.from('difficulty_config').update(updates).eq('id', c.id);
            if (error) {
                statusElement.className = 'error-text';
                statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Config ${c.difficulty_level} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`;
                return;
            }
        }
        await fetchAllData();
    };

    window.updateHealthQuestions = async () => { /* Logic for S4 Q text */
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å...';
        statusElement.className = 'loading-text';
        for (const q of healthQuestionsData) {
            const newText = document.getElementById(`q4_text_${q.id}`).value.trim();
            if (newText !== q.q_text) {
                const { error } = await supabase.from('health_questions_s4').update({ q_text: newText }).eq('id', q.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Q${q.q_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData();
    };
    
    window.updateFollowUpNames = async () => { /* Logic for S4 Follow-up Names */
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...';
        statusElement.className = 'loading-text';
        for (const q of followUpNamesData) {
            const newName = document.getElementById(`fu_name_${q.id}`).value.trim();
            if (newName !== q.step_name) {
                const { error } = await supabase.from('s4_follow_up_names').update({ step_name: newName }).eq('id', q.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Step ${q.step_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData(); 
    };
    
    window.updateS5Names = async () => { /* Logic for S5 Step Names */
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
        statusElement.className = 'loading-text';
        for (const s of s5StepsData) {
            const newName = document.getElementById(`s5_name_${s.id}`).value.trim();
            if (newName !== s.step_name) {
                const { error } = await supabase.from('scripts_s5').update({ step_name: newName }).eq('id', s.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Step ${s.step_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData();
    };
    
    // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL (UPDATE AUDIO URL) ---
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏î‡πÜ
    window.uploadAudio = async (fileInputId, table, column, index_col, index_val, statusId) => {
        const fileInput = document.getElementById(fileInputId);
        const uploadStatus = document.getElementById(statusId);
        const file = fileInput.files[0];

        if (!file) { uploadStatus.className = 'error-text'; uploadStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'; return; }
        
        uploadStatus.className = 'loading-text';
        uploadStatus.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ${file.name}...`;

        const fileExtension = file.name.split('.').pop();
        const sectionPrefix = table.split('_')[1] || 'generic';
        const path = `customer_audio/${sectionPrefix}/${sectionPrefix}_${index_val}_${uuidv4()}.${fileExtension}`; 

        try {
            // 5.1 Upload file to Supabase Storage
            const { error: uploadError } = await supabase.storage
                .from('responses') 
                .upload(path, file, { upsert: true });
            if (uploadError) throw uploadError;

            // 5.2 Get Public URL
            const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(path);

            // 5.3 Update URL in the Database table
            const updateObject = {};
            updateObject[column] = publicUrl;
            
            const { error: updateError } = await supabase
                .from(table)
                .update(updateObject)
                .eq(index_col, index_val);

            if (updateError) throw updateError;

            uploadStatus.className = 'success-text';
            uploadStatus.textContent = '‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
            
            // 5.4 Reload data and UI
            await fetchAllData();

        } catch (err) {
            console.error('Upload or Update error:', err);
            uploadStatus.className = 'error-text';
            uploadStatus.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Bucket name ‡πÅ‡∏•‡∏∞ RLS policies (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ policy INSERT/UPDATE/SELECT/DELETE ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö anon).`;
        }
    };
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Q4 Yes Trigger (‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å uploadAudio)
    window.uploadYesTriggerAudio = async () => {
        if (!yesTriggerQ) {
             document.getElementById('uploadStatus').className = 'error-text';
             document.getElementById('uploadStatus').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Yes Trigger ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
             return;
        }
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å: uploadAudio(fileInputId, table, column, index_col, index_val, statusId)
        await window.uploadAudio('yesTriggerFileInput', 'health_questions_s4', 'yes_trigger_url', 'id', yesTriggerQ.id, 'uploadStatus');
    };

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', fetchAllData);
</script>
</body>
</html>
