<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Admin Panel: Manage Content (Array Support)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 0; margin: 0;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto; 
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 { text-align: center; color: #007bff; margin-bottom: 20px; }
        .status-bar {
            text-align: center; padding: 10px; margin-bottom: 20px;
            border-radius: 6px; background-color: #e9ecef;
        }
        .tab-menu { display: flex; flex-wrap: wrap; border-bottom: 2px solid #ddd; margin-bottom: 20px; gap: 5px; }
        .tab-button {
            background-color: #f8f9fa; border: 1px solid #ddd; border-bottom: none;
            padding: 10px 15px; cursor: pointer; font-weight: bold; font-size: 14px;
            border-top-left-radius: 8px; border-top-right-radius: 8px;
            margin-bottom: -1px;
        }
        .tab-button.active { background-color: white; border-color: #ddd; border-bottom: 2px solid white; color: #007bff; }
        .tab-content { padding-top: 20px; }
        .item-row { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #fff; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        textarea, input[type="text"], input[type="number"], select {
            width: 98%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;
        }
        
        /* Styling for Config Inputs */
        .config-grid {
            display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; 
            background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee;
        }
        .config-grid label { margin-top: 0; font-size: 14px; }
        .config-grid input { width: 60px; text-align: center; margin-left: 5px; }

        /* Styling for Tag Selector Area */
        .tag-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f1f8ff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #cce5ff;
        }
        .tag-control select { width: auto; flex-grow: 1; }
        .tag-btn {
            background-color: #17a2b8; color: white; border: none; padding: 8px 15px;
            border-radius: 4px; cursor: pointer; font-size: 14px; white-space: nowrap;
        }
        .tag-btn:hover { background-color: #138496; }

        button {
            padding: 10px 20px; margin-top: 15px; font-size: 16px; cursor: pointer;
            border: none; border-radius: 6px; background-color: #28a745; color: white;
        }
        button:hover { background-color: #218838; }
        .save-button { background-color: #007bff; width: 100%; margin-top: 20px; padding: 15px; font-size: 18px;}
        .save-button:hover { background-color: #0056b3; }
        
        .audio-url-display { font-size: 12px; color: #666; flex-grow: 1; word-break: break-all; margin-top: 5px; display: block;}
        .upload-area { margin-top: 10px; padding: 10px; border: 1px dashed #007bff; border-radius: 4px; background: #f0f8ff; }
        
        .loading-text { color: orange; font-weight: bold; }
        .success-text { color: green; font-weight: bold; }
        .error-text { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üî• Admin Panel: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å (Full Option V3)</h1>
    <div class="status-bar">
        <p class="loading-text" id="statusMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div class="tab-menu" id="tabMenu"></div>

    <div class="tab-content">
        <div id="configSection" class="data-section" data-tab="config" style="display: none;">
            <h2>0. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠ (Difficulty Config)</h2>
            <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á (S1-S5) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å</p>
            <div id="configList"></div>
            <button onclick="updateConfig()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="s1Section" class="data-section" data-tab="s1" style="display: none;">
            <h2>1. ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (S1)</h2>
            <div id="s1List"></div>
        </div>
        
        <div id="s2Section" class="data-section" data-tab="s2" style="display: none;">
            <h2>2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S2)</h2>
            <div id="s2List"></div>
            <button onclick="updateS2Text()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S2 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="s3Section" class="data-section" data-tab="s3" style="display: none;">
            <h2>3. ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (S3)</h2>
            <div id="s3List"></div>
            <button onclick="updateS3Text()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S3 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="s4Section" class="data-section" data-tab="s4" style="display: none;">
            <h2>4.1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å (S4)</h2>
            <div id="q4List"></div>
            <button onclick="updateHealthQuestions()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Q4 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            
            <hr style="margin: 30px 0;">
            
            <h3>4.2 Yes Trigger Audio (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</h3>
            <div class="item-row" style="border: 2px solid #007bff;">
                <label>URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà" (Trigger):</label>
                <div class="audio-url-display" id="yesTriggerUrlDisplay"></div>
                <audio id="yesTriggerAudio" controls style="width: 100%; margin-top: 5px;"></audio>
                <div class="upload-area">
                    <input type="file" id="yesTriggerFileInput" accept="audio/*">
                    <button onclick="uploadYesTriggerAudio()">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á Trigger ‡πÉ‡∏´‡∏°‡πà</button>
                    <span id="uploadStatus" style="margin-left:10px; font-weight:bold;"></span>
                </div>
            </div>
            
            <hr style="margin: 30px 0;">

            <h3>4.3 ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Follow-up Names)</h3>
            <div id="fuNamesList"></div>
            <button onclick="updateFollowUpNames()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            
            <hr style="margin: 30px 0;">

            <h3>4.4 ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Follow-up Replies)</h3>
            <div id="fuRepliesList"></div>
        </div>
        
        <div id="s5Section" class="data-section" data-tab="s5" style="display: none;">
            <h2>5. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (S5)</h2>
            <div id="s5List"></div>
            <button onclick="updateS5Names()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let configData=[], s1FilesData=[], s2QuestionsData=[], s3ObjectionsData=[], healthQuestionsData=[], followUpNamesData=[], followUpRepliesData=[], s5StepsData=[], yesTriggerQ=null;

    const statusElement = document.getElementById('statusMessage');
    const tabSections = ['config', 's1', 's2', 's3', 's4', 's5'];
    const tabNames = { 'config':'0. Config', 's1':'1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß', 's2':'2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', 's3':'3. ‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á', 's4':'4. ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', 's5':'5. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' };

    // --- 1. UI Helpers ---
    const switchTab = (tab) => {
        tabSections.forEach(sec => {
            const div = document.querySelector(`[data-tab="${sec}"]`);
            const btn = document.querySelector(`[data-tab-button="${sec}"]`);
            if(div) div.style.display = (sec === tab) ? 'block' : 'none';
            if(btn) (sec === tab) ? btn.classList.add('active') : btn.classList.remove('active');
        });
    };

    const renderTabMenu = () => {
        const menu = document.getElementById('tabMenu'); menu.innerHTML = '';
        tabSections.forEach(sec => {
            const btn = document.createElement('button');
            btn.className = 'tab-button'; btn.textContent = tabNames[sec];
            btn.setAttribute('data-tab-button', sec);
            btn.onclick = () => switchTab(sec);
            menu.appendChild(btn);
        });
        switchTab('config');
    };

    // --- 2. Fetch Data ---
    const fetchAllData = async () => {
        statusElement.className = 'loading-text'; statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
        try {
            let { data: c } = await supabase.from('difficulty_config').select('*').order('id'); configData = c;
            let { data: s1 } = await supabase.from('customer_replies_s1').select('*').order('turn_index'); s1FilesData = s1;
            let { data: s2 } = await supabase.from('questions_s2').select('*').order('q_index'); s2QuestionsData = s2;
            let { data: s3 } = await supabase.from('objections_s3').select('*').order('ob_index'); s3ObjectionsData = s3;
            let { data: s4 } = await supabase.from('health_questions_s4').select('*').order('q_index'); healthQuestionsData = s4; yesTriggerQ = s4.find(q=>q.is_yes_trigger);
            let { data: fuN } = await supabase.from('s4_follow_up_names').select('*').order('step_index'); followUpNamesData = fuN;
            let { data: fuR } = await supabase.from('s4_follow_up_replies').select('*').order('step_index'); followUpRepliesData = fuR;
            let { data: s5 } = await supabase.from('scripts_s5').select('*').order('step_index'); s5StepsData = s5;

            renderAll();
            statusElement.className = 'success-text'; statusElement.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        } catch (err) {
            console.error(err); statusElement.className = 'error-text'; statusElement.textContent = '‚ùå Error: ' + err.message;
        }
    };

    // --- 3. Component Generators ---
    
    // Helper: ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product Tag (Array Aware)
    const createTagSelector = (currentVal, table, id) => {
        let val = 'all';
        if (currentVal && currentVal.length > 0) {
            val = currentVal[0].replace(/{|}/g, ''); // ‡∏•‡∏ö { } ‡∏≠‡∏≠‡∏Å
        }

        return `
            <div class="tag-control">
                <label style="margin:0; margin-right:10px;">üè∑Ô∏è Product Tag:</label>
                <select id="tag_${table}_${id}">
                    <option value="all" ${val === 'all' ? 'selected' : ''}>All (‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô)</option>
                    <option value="Health" ${val === 'Health' ? 'selected' : ''}>Health (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</option>
                    <option value="Life" ${val === 'Life' ? 'selected' : ''}>Life (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)</option>
                    <option value="Retirement" ${val === 'Retirement' ? 'selected' : ''}>Retirement (‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç)</option>
                </select>
                <button class="tag-btn" onclick="window.updateProductTag('${table}', ${id}, 'tag_${table}_${id}')">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tag</button>
            </div>
        `;
    };

    const createAudioUploader = (id, table, col, idxCol, idxVal) => `
        <div class="upload-area">
            <input type="file" id="${id}_file" accept="audio/*">
            <button onclick="window.uploadAudio('${id}_file', '${table}', '${col}', '${idxCol}', '${idxVal}')">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <span id="${id}_status" style="margin-left:10px; font-size:12px;"></span>
        </div>
    `;

    // --- 4. Render Functions ---
    const renderAll = () => { renderTabMenu(); renderConfig(); renderS1(); renderS2(); renderS3(); renderS4(); renderS5(); };

    // ‚úÖ Render Config ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Input
    const renderConfig = () => {
        const list = document.getElementById('configList'); 
        list.innerHTML = '';
        
        configData.forEach(c => {
            list.innerHTML += `
                <div class="item-row">
                    <strong style="font-size: 18px; color: #007bff;">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${c.difficulty_level.toUpperCase()}</strong>
                    <div class="config-grid">
                        <label>S1 (‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß): <input type="number" id="conf_s1_${c.id}" value="${c.max_s1}"></label>
                        <label>S2 (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°): <input type="number" id="conf_s2_${c.id}" value="${c.max_s2}"></label>
                        <label>S3 (‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á): <input type="number" id="conf_s3_${c.id}" value="${c.max_s3}"></label>
                        <label>S4 (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û): <input type="number" id="conf_s4_${c.id}" value="${c.max_s4}"></label>
                        <label>S5 (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô): <input type="number" id="conf_s5_${c.id}" value="${c.max_s5}"></label>
                    </div>
                </div>`;
        });
    };

    const renderS1 = () => {
        const list = document.getElementById('s1List'); list.innerHTML = '';
        s1FilesData.forEach(f => {
            list.innerHTML += `
                <div class="item-row">
                    <strong>Turn ${f.turn_index}</strong> ${f.is_finale ? '<span style="color:red; font-weight:bold;">(Finale/‡∏ö‡∏ó‡∏à‡∏ö)</span>' : ''}
                    <div class="audio-url-display">URL: ${f.audio_url || '-'}</div>
                    <audio src="${f.audio_url}" controls style="display:block; margin:5px 0; height:30px; width:100%;"></audio>
                    ${createTagSelector(f.product_type, 'customer_replies_s1', f.id)}
                    ${createAudioUploader(`s1_${f.id}`, 'customer_replies_s1', 'audio_url', 'id', f.id)}
                </div>`;
        });
    };

    const renderS2 = () => {
        const list = document.getElementById('s2List'); list.innerHTML = '';
        s2QuestionsData.forEach(q => {
            list.innerHTML += `
                <div class="item-row">
                    <strong>Q${q.q_index}</strong>
                    <textarea id="s2_txt_${q.id}" rows="2">${q.q_text||''}</textarea>
                    <div class="audio-url-display">URL: ${q.audio_url || '-'}</div>
                    <audio src="${q.audio_url}" controls style="display:block; margin:5px 0; height:30px; width:100%;"></audio>
                    ${createTagSelector(q.product_type, 'questions_s2', q.id)}
                    ${createAudioUploader(`s2_${q.id}`, 'questions_s2', 'audio_url', 'id', q.id)}
                </div>`;
        });
    };

    const renderS3 = () => {
        const list = document.getElementById('s3List'); list.innerHTML = '';
        s3ObjectionsData.forEach(o => {
            list.innerHTML += `
                <div class="item-row">
                    <strong>Objection ${o.ob_index}</strong>
                    <textarea id="s3_txt_${o.id}" rows="2">${o.ob_text||''}</textarea>
                    <div class="audio-url-display">URL: ${o.audio_url || '-'}</div>
                    <audio src="${o.audio_url}" controls style="display:block; margin:5px 0; height:30px; width:100%;"></audio>
                    ${createTagSelector(o.product_type, 'objections_s3', o.id)}
                    ${createAudioUploader(`s3_${o.id}`, 'objections_s3', 'audio_url', 'id', o.id)}
                </div>`;
        });
    };

    const renderS4 = () => {
        const q4div = document.getElementById('q4List'); q4div.innerHTML = '';
        healthQuestionsData.forEach(q => {
            q4div.innerHTML += `
                <div class="item-row">
                    <strong>Q${q.q_index}</strong> ${q.is_yes_trigger ? '<span style="color:red; font-weight:bold;">(Trigger Question)</span>' : ''}
                    <textarea id="q4_txt_${q.id}" rows="2">${q.q_text||''}</textarea>
                    ${createTagSelector(q.product_type, 'health_questions_s4', q.id)}
                </div>`;
        });
        
        const ytDisplay = document.getElementById('yesTriggerUrlDisplay');
        const ytAudio = document.getElementById('yesTriggerAudio');
        if(yesTriggerQ) {
            ytDisplay.textContent = yesTriggerQ.yes_trigger_url || '-';
            ytAudio.src = yesTriggerQ.yes_trigger_url;
        }

        const fuN = document.getElementById('fuNamesList'); fuN.innerHTML = '';
        followUpNamesData.forEach(n => {
            fuN.innerHTML += `
                <div class="item-row">
                    <strong>Step ${n.step_index}</strong>
                    <input type="text" id="fun_txt_${n.id}" value="${n.step_name||''}">
                    ${createTagSelector(n.product_type, 's4_follow_up_names', n.id)}
                </div>`;
        });

        const fuR = document.getElementById('fuRepliesList'); fuR.innerHTML = '';
        followUpRepliesData.forEach(r => {
            fuR.innerHTML += `
                <div class="item-row">
                    <strong>Reply ${r.step_index}</strong>
                    <div class="audio-url-display">URL: ${r.customer_audio_url || '-'}</div>
                    <audio src="${r.customer_audio_url}" controls style="display:block; margin:5px 0; height:30px; width:100%;"></audio>
                    ${createTagSelector(r.product_type, 's4_follow_up_replies', r.id)}
                    ${createAudioUploader(`fur_${r.id}`, 's4_follow_up_replies', 'customer_audio_url', 'id', r.id)}
                </div>`;
        });
    };

    const renderS5 = () => {
        const list = document.getElementById('s5List'); list.innerHTML = '';
        s5StepsData.forEach(s => {
            list.innerHTML += `
                <div class="item-row">
                    <strong>Step ${s.step_index}</strong>
                    <textarea id="s5_txt_${s.id}" rows="2">${s.step_name||''}</textarea>
                    <div class="audio-url-display">URL: ${s.customer_audio_url || '-'}</div>
                    <audio src="${s.customer_audio_url}" controls style="display:block; margin:5px 0; height:30px; width:100%;"></audio>
                    ${createTagSelector(s.product_type, 'scripts_s5', s.id)}
                    ${createAudioUploader(`s5_${s.id}`, 'scripts_s5', 'customer_audio_url', 'id', s.id)}
                </div>`;
        });
    };

    // --- 5. Action Functions ---

    // ‚úÖ FIXED: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Config ‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå RLS/Error
    window.updateConfig = async () => {
        const status = document.getElementById('statusMessage');
        status.className = 'loading-text'; 
        status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Config...';
        
        try {
            let successCount = 0;

            for (const c of configData) {
                // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Int) ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error Type
                const s1 = parseInt(document.getElementById(`conf_s1_${c.id}`).value) || 0;
                const s2 = parseInt(document.getElementById(`conf_s2_${c.id}`).value) || 0;
                const s3 = parseInt(document.getElementById(`conf_s3_${c.id}`).value) || 0;
                const s4 = parseInt(document.getElementById(`conf_s4_${c.id}`).value) || 0;
                const s5 = parseInt(document.getElementById(`conf_s5_${c.id}`).value) || 0;

                const { data, error } = await supabase
                    .from('difficulty_config')
                    .update({ 
                        max_s1: s1, 
                        max_s2: s2, 
                        max_s3: s3, 
                        max_s4: s4, 
                        max_s5: s5 
                    })
                    .eq('id', c.id)
                    .select();

                if (error) {
                    console.error(`‚ùå Error updating ID ${c.id}:`, error);
                    throw new Error(`ID ${c.id}: ${error.message}`);
                }
                
                if (data && data.length > 0) {
                    successCount++;
                } else {
                    console.warn(`‚ö†Ô∏è Warning ID ${c.id}: No data returned. Check RLS or ID.`);
                }
            }

            await fetchAllData();
            
            if (successCount === configData.length) {
                status.className = 'success-text'; 
                status.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!';
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
            } else {
                status.className = 'error-text';
                status.textContent = `‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ${successCount}/${configData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ Console)`;
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå RLS ‡πÉ‡∏ô Supabase');
            }

        } catch (err) {
            console.error(err);
            status.className = 'error-text'; 
            status.textContent = '‚ùå Error: ' + err.message;
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message + '\n\n(‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ RLS Policy ‡πÉ‡∏ô Supabase)');
        }
    };

    window.updateProductTag = async (table, id, selectId) => {
        const val = document.getElementById(selectId).value;
        const status = document.getElementById('statusMessage');
        status.className = 'loading-text'; status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tag...';

        const { error } = await supabase.from(table).update({ product_type: [val] }).eq('id', id);

        if(error) {
            status.className = 'error-text'; status.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tag ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message;
        } else {
            status.className = 'success-text'; status.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Tag ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        }
    };

    window.uploadAudio = async (fileId, table, col, idxCol, idxVal) => {
        const file = document.getElementById(fileId).files[0];
        const status = document.getElementById(fileId.replace('_file', '_status'));
        if(!file) { alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
        
        status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
        const path = `admin_uploads/${Date.now()}_${file.name}`;
        
        const { error: upErr } = await supabase.storage.from('responses').upload(path, file);
        if(upErr) { status.textContent = '‚ùå Upload Failed'; console.error(upErr); return; }

        const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(path);
        
        const updateObj = {}; updateObj[col] = publicUrl;
        const { error: dbErr } = await supabase.from(table).update(updateObj).eq(idxCol, idxVal);

        if(dbErr) { status.textContent = '‚ùå DB Update Failed'; console.error(dbErr); }
        else { status.textContent = '‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•)'; alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'); await fetchAllData(); }
    };

    window.uploadYesTriggerAudio = async () => {
        if(!yesTriggerQ) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Yes Trigger');
        const status = document.getElementById('uploadStatus');
        status.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Trigger...';
        await window.uploadAudio('yesTriggerFileInput', 'health_questions_s4', 'yes_trigger_url', 'id', yesTriggerQ.id);
    };

    // Text Updates
    window.updateS2Text = async () => {
        for(const q of s2QuestionsData) {
            const txt = document.getElementById(`s2_txt_${q.id}`).value;
            if(txt !== q.q_text) await supabase.from('questions_s2').update({q_text: txt}).eq('id', q.id);
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S2 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };
    window.updateS3Text = async () => {
        for(const o of s3ObjectionsData) {
            const txt = document.getElementById(`s3_txt_${o.id}`).value;
            if(txt !== o.ob_text) await supabase.from('objections_s3').update({ob_text: txt}).eq('id', o.id);
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S3 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };
    window.updateHealthQuestions = async () => {
        for(const q of healthQuestionsData) {
            const txt = document.getElementById(`q4_txt_${q.id}`).value;
            if(txt !== q.q_text) await supabase.from('health_questions_s4').update({q_text: txt}).eq('id', q.id);
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Q4 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };
    window.updateFollowUpNames = async () => {
        for(const n of followUpNamesData) {
            const txt = document.getElementById(`fun_txt_${n.id}`).value;
            if(txt !== n.step_name) await supabase.from('s4_follow_up_names').update({step_name: txt}).eq('id', n.id);
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };
    window.updateS5Names = async () => {
        for(const s of s5StepsData) {
            const txt = document.getElementById(`s5_txt_${s.id}`).value;
            if(txt !== s.step_name) await supabase.from('scripts_s5').update({step_name: txt}).eq('id', s.id);
        }
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S5 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    };

    // Init
    document.addEventListener('DOMContentLoaded', fetchAllData);

</script>
</body>
</html>
