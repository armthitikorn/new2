<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Admin Panel: Health Simulator Content</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 0; 
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto; 
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 { 
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
        }
        .status-bar {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            background-color: #e9ecef;
        }
        /* --- Navigation Tabs --- */
        .tab-menu {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            gap: 5px;
        }
        .tab-button {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
            margin-bottom: -1px; /* Overlap border */
        }
        .tab-button.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 2px solid white;
            color: #007bff;
        }
        .tab-content {
            padding-top: 20px;
        }
        
        /* --- Section Styles --- */
        h2 { color: #333; margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        h3 { color: #555; margin-top: 10px; font-size: 1.1em;}
        .data-section {
            padding: 10px;
        }
        .item-row {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            background-color: #fff;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        textarea, input[type="text"], input[type="number"] {
            width: 98%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            margin-top: 15px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: background-color 0.3s;
            background-color: #28a745;
            color: white;
            white-space: nowrap;
        }
        button:hover { background-color: #218838; }
        .save-button {
            background-color: #007bff;
        }
        .save-button:hover {
            background-color: #0056b3;
        }
        .audio-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .audio-url-display {
            font-size: 12px;
            word-break: break-all;
            color: #666;
            flex-grow: 1;
        }
        .upload-area {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #007bff;
            border-radius: 4px;
            flex-basis: 100%;
        }
        /* --- Responsive Grid for Config/Audio --- */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .flex-col {
            padding: 5px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        
        /* Status Text */
        .loading-text { color: orange; font-weight: bold; }
        .success-text { color: green; font-weight: bold; }
        .error-text { color: red; font-weight: bold; }

        /* Media Queries for Mobile/Tablet */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px auto;
            }
            .tab-menu {
                flex-direction: column;
            }
            .tab-button {
                width: 100%;
                border-radius: 6px;
                margin-bottom: 5px;
            }
            .tab-button.active {
                border-bottom: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üî• Admin Panel: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h1>
    <div class="status-bar">
        <p class="loading-text" id="statusMessage">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase...</p>
    </div>

    <div class="tab-menu" id="tabMenu">
        </div>

    <div class="tab-content">
        <div id="configSection" class="data-section" data-tab="config" style="display: none;">
            <h2>0. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö (Difficulty Configuration)</h2>
            <div id="configList"></div>
            <button onclick="updateConfig()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="s1Section" class="data-section" data-tab="s1" style="display: none;">
            <h2>1. ‡∏ö‡∏ó‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢ (S1 - Customer Replies)</h2>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô: (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô FINALE)</p>
            <div id="s1List"></div>
        </div>
        
        <div id="s2Section" class="data-section" data-tab="s2" style="display: none;">
            <h2>2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S2 - Product Questions)</h2>
            <div id="s2List"></div>
        </div>

        <div id="s3Section" class="data-section" data-tab="s3" style="display: none;">
            <h2>3. ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (S3 - Objections)</h2>
            <div id="s3List"></div>
        </div>

        <div id="s4Section" class="data-section" data-tab="s4" style="display: none;">
            <h2>4.1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å (S4 - Q1 ‡∏ñ‡∏∂‡∏á Q5)</h2>
            <div id="q4List"></div>
            <button onclick="updateHealthQuestions()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            
            <h3>4.2 ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà" (Q4 Yes Trigger)</h3>
            <p>URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πà" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Q4) ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</p>
            <div class="item-row">
                <label>URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
                <div class="audio-url-display" id="yesTriggerUrlDisplay"></div>
                <audio id="yesTriggerAudio" controls></audio>
                
                <div class="upload-area">
                    <label for="yesTriggerFileInput">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (.webm/MP3):</label>
                    <input type="file" id="yesTriggerFileInput" accept="audio/*">
                    <button onclick="uploadYesTriggerAudio()">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL</button>
                    <p class="loading-text" id="uploadStatus"></p>
                </div>
            </div>
            
            <h3>4.3 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (S4 Follow-up Names)</h3>
            <div id="fuNamesList"></div>
            <button onclick="updateFollowUpNames()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            
            <h3>4.4 ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (S4 Follow-up Replies)</h3>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</p>
            <div id="fuRepliesList"></div>
        </div>
        
        <div id="s5Section" class="data-section" data-tab="s5" style="display: none;">
            <h2>5. ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (S5)</h2>
            <div id="s5List"></div>
            <button onclick="updateS5Names()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

    // ** 1. Supabase Configuration (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö index1.html) **
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Global Data Stores
    let configData = [];
    let s1FilesData = [];
    let s2QuestionsData = [];
    let s3ObjectionsData = [];
    let healthQuestionsData = [];
    let followUpNamesData = [];
    let followUpRepliesData = [];
    let s5StepsData = [];
    let yesTriggerQ = null;

    const statusElement = document.getElementById('statusMessage');
    const tabSections = ['config', 's1', 's2', 's3', 's4', 's5'];
    const tabNames = {
        'config': '0. Config/‡∏£‡∏≠‡∏ö', 's1': '1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (S1)', 's2': '2. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (S2)', 
        's3': '3. ‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á (S3)', 's4': '4. ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (S4)', 's5': '5. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (S5)'
    };

    // --- Tab Management ---
    const switchTab = (tabName) => {
        tabSections.forEach(section => {
            const content = document.querySelector(`[data-tab="${section}"]`);
            const button = document.querySelector(`[data-tab-button="${section}"]`);
            if (content && button) {
                if (section === tabName) {
                    content.style.display = 'block';
                    button.classList.add('active');
                } else {
                    content.style.display = 'none';
                    button.classList.remove('active');
                }
            }
        });
    };

    const renderTabMenu = () => {
        const tabMenu = document.getElementById('tabMenu');
        tabMenu.innerHTML = '';
        tabSections.forEach((section, index) => {
            const button = document.createElement('button');
            button.className = 'tab-button';
            button.setAttribute('data-tab-button', section);
            button.textContent = tabNames[section];
            button.onclick = () => switchTab(section);
            tabMenu.appendChild(button);
        });
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        switchTab('config'); 
    };

    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (READ) ---
    const fetchAllData = async () => {
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

        try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á... (‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö)
            
            // 2.0 Config
            const { data: cData, error: cError } = await supabase.from('difficulty_config').select('*');
            if (cError) throw cError; configData = cData;

            // 2.1 S1
            const { data: s1Data, error: s1Error } = await supabase.from('customer_replies_s1').select('*').order('turn_index', { ascending: true });
            if (s1Error) throw s1Error; s1FilesData = s1Data;
            
            // 2.2 S2
            const { data: s2Data, error: s2Error } = await supabase.from('questions_s2').select('*').order('q_index', { ascending: true });
            if (s2Error) throw s2Error; s2QuestionsData = s2Data;

            // 2.3 S3
            const { data: s3Data, error: s3Error } = await supabase.from('objections_s3').select('*').order('ob_index', { ascending: true });
            if (s3Error) throw s3Error; s3ObjectionsData = s3Data;
            
            // 2.4 S4 - Health Questions
            const { data: qData, error: qError } = await supabase.from('health_questions_s4').select('*').order('q_index', { ascending: true });
            if (qError) throw qError; healthQuestionsData = qData;
            yesTriggerQ = qData.find(q => q.is_yes_trigger) || null;
            
            // 2.5 S4 - Follow Up Names
            const { data: fuData, error: fuError } = await supabase.from('s4_follow_up_names').select('*').order('step_index', { ascending: true });
            if (fuError) throw fuError; followUpNamesData = fuData;
            
            // 2.6 S4 - Follow Up Replies
            const { data: furData, error: furError } = await supabase.from('s4_follow_up_replies').select('*').order('step_index', { ascending: true });
            if (furError) throw furError; followUpRepliesData = furData;

            // 2.7 S5
            const { data: s5Data, error: s5Error } = await supabase.from('scripts_s5').select('*').order('step_index', { ascending: true });
            if (s5Error) throw s5Error; s5StepsData = s5Data;

            renderUI();
            statusElement.className = 'success-text';
            statusElement.textContent = '‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';

        } catch (err) {
            console.error('Fetch error:', err);
            statusElement.className = 'error-text';
            statusElement.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${err.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS ‡πÅ‡∏•‡∏∞ Column Names.`;
        }
    };

    // --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Section ---
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô createAudioUploaderHTML ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const createAudioUploaderHTML = (id, table, column, index_col, index_val) => {
        return `
            <div class="upload-area">
                <label for="${id}_file_input">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (.webm/MP3):</label>
                <input type="file" id="${id}_file_input" accept="audio/*">
                <button onclick="uploadAudio('${id}_file_input', '${table}', '${column}', '${index_col}', '${index_val}', '${id}_status')">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL</button>
                <p class="loading-text" id="${id}_status"></p>
            </div>
        `;
    };
    
    const renderConfig = () => {
        const list = document.getElementById('configList');
        list.innerHTML = '';
        configData.forEach(c => {
            list.innerHTML += `
                <div class="item-row" data-id="${c.id}">
                    <strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${c.difficulty_level.toUpperCase()}</strong>
                    <div class="config-grid">
                        <div class="flex-col">S1 (‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß): <input type="number" id="c_s1_${c.id}" value="${c.max_s1}"></div>
                        <div class="flex-col">S2 (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°): <input type="number" id="c_s2_${c.id}" value="${c.max_s2}"></div>
                        <div class="flex-col">S3 (‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á): <input type="number" id="c_s3_${c.id}" value="${c.max_s3}"></div>
                        <div class="flex-col">S4 (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û): <input type="number" id="c_s4_${c.id}" value="${c.max_s4}"></div>
                        <div class="flex-col">S5 (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô): <input type="number" id="c_s5_${c.id}" value="${c.max_s5}"></div>
                    </div>
                </div>
            `;
        });
    };
    
    const renderS1 = () => {
        const list = document.getElementById('s1List');
        list.innerHTML = '';
        s1FilesData.forEach(f => {
            const isFinale = f.is_finale ? ' (FINALE - Q6)' : '';
            const uploadId = `s1_upload_${f.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${f.id}">
                    <strong>Turn ${f.turn_index}${isFinale}:</strong>
                    <div class="audio-control">
                        <div class="audio-url-display">${f.audio_url}</div>
                        <audio src="${f.audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'customer_replies_s1', 'audio_url', 'id', f.id)}
                </div>
            `;
        });
    };

    const renderS2 = () => {
        const list = document.getElementById('s2List');
        list.innerHTML = '';
        s2QuestionsData.forEach(q => {
            const uploadId = `s2_upload_${q.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${q.id}">
                    <strong>Q${q.q_index}</strong>
                    <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</label>
                    <textarea id="s2_text_${q.id}" rows="2">${q.q_text || ''}</textarea>
                    <div class="audio-control">
                        <div class="audio-url-display">${q.audio_url}</div>
                        <audio src="${q.audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'questions_s2', 'audio_url', 'id', q.id)}
                </div>
            `;
        });
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S2
        list.innerHTML += `<button onclick="updateS2Text()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° S2</button>`;
    };

    const renderS3 = () => {
        const list = document.getElementById('s3List');
        list.innerHTML = '';
        s3ObjectionsData.forEach(o => {
            const uploadId = `s3_upload_${o.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${o.id}">
                    <strong>Objection ${o.ob_index}</strong>
                    <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á:</label>
                    <textarea id="s3_text_${o.id}" rows="2">${o.ob_text || ''}</textarea>
                    <div class="audio-control">
                        <div class="audio-url-display">${o.audio_url}</div>
                        <audio src="${o.audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'objections_s3', 'audio_url', 'id', o.id)}
                </div>
            `;
        });
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° S3
        list.innerHTML += `<button onclick="updateS3Text()" class="save-button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á S3</button>`;
    };
    
    // S4 (Health Qs & Follow-up Names) 
    const renderS4 = () => {
        // 4.1 Health Questions Text
        const q4List = document.getElementById('q4List');
        q4List.innerHTML = '';
        healthQuestionsData.forEach(q => {
            const isTrigger = q.is_yes_trigger ? ' (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô)' : '';
            q4List.innerHTML += `
                <div class="item-row" data-id="${q.id}">
                    <strong>Q${q.q_index}${isTrigger}:</strong>
                    <textarea id="q4_text_${q.id}" rows="3">${q.q_text}</textarea>
                </div>
            `;
        });
        
        // 4.2 Follow Up Names Text
        const fuNamesList = document.getElementById('fuNamesList');
        fuNamesList.innerHTML = '';
        followUpNamesData.forEach(q => {
            fuNamesList.innerHTML += `
                <div class="item-row" data-id="${q.id}">
                    <strong>Step ${q.step_index}:</strong>
                    <input type="text" id="fu_name_${q.id}" value="${q.step_name}">
                </div>
            `;
        });
        
        // 4.3 Follow Up Replies Audio
        const fuRepliesList = document.getElementById('fuRepliesList');
        fuRepliesList.innerHTML = '';
        followUpRepliesData.forEach(r => {
            const uploadId = `fu_reply_upload_${r.id}`;
            fuRepliesList.innerHTML += `
                <div class="item-row" data-id="${r.id}">
                    <strong>F${r.step_index}: (${r.disease_name || '‡πÇ‡∏£‡∏Ñ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç'})</strong>
                    <div class="audio-control">
                        <div class="audio-url-display">${r.customer_audio_url}</div>
                        <audio src="${r.customer_audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 's4_follow_up_replies', 'customer_audio_url', 'id', r.id)}
                </div>
            `;
        });
        
        // 4.4 Yes Trigger Audio Display
        const yesTriggerUrlDisplay = document.getElementById('yesTriggerUrlDisplay');
        const yesTriggerAudio = document.getElementById('yesTriggerAudio');
        if (yesTriggerQ) {
            yesTriggerUrlDisplay.textContent = yesTriggerQ.yes_trigger_url || 'N/A';
            yesTriggerAudio.src = yesTriggerQ.yes_trigger_url;
            yesTriggerAudio.load();
        } else {
            yesTriggerUrlDisplay.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Yes Trigger (is_yes_trigger=true)';
        }
    };

    const renderS5 = () => {
        const list = document.getElementById('s5List');
        list.innerHTML = '';
        s5StepsData.forEach(s => {
            const uploadId = `s5_upload_${s.id}`;
            list.innerHTML += `
                <div class="item-row" data-id="${s.id}">
                    <strong>Step ${s.step_index}</strong>
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô/‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå:</label>
                    <textarea id="s5_name_${s.id}" rows="2">${s.step_name}</textarea>
                    <div class="audio-control">
                        <div class="audio-url-display">${s.customer_audio_url}</div>
                        <audio src="${s.customer_audio_url}" controls></audio>
                    </div>
                    ${createAudioUploaderHTML(uploadId, 'scripts_s5', 'customer_audio_url', 'id', s.id)}
                </div>
            `;
        });
    };

    const renderUI = () => {
        renderTabMenu(); 
        renderConfig();
        renderS1();
        renderS2();
        renderS3();
        renderS4();
        renderS5();
    };

    // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (UPDATE TEXT) ---
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateConfig, updateHealthQuestions, updateFollowUpNames ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)

    // NEW: Update S2 Text
    window.updateS2Text = async () => {
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° S2...';
        statusElement.className = 'loading-text';
        for (const q of s2QuestionsData) {
            const newText = document.getElementById(`s2_text_${q.id}`).value.trim();
            if (newText !== q.q_text) {
                const { error } = await supabase.from('questions_s2').update({ q_text: newText }).eq('id', q.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å S2 Q${q.q_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData();
    };
    
    // NEW: Update S3 Text
    window.updateS3Text = async () => {
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á S3...';
        statusElement.className = 'loading-text';
        for (const o of s3ObjectionsData) {
            const newText = document.getElementById(`s3_text_${o.id}`).value.trim();
            if (newText !== o.ob_text) {
                const { error } = await supabase.from('objections_s3').update({ ob_text: newText }).eq('id', o.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å S3 OB${o.ob_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData();
    };
    
    // --- (‡∏£‡∏ß‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateConfig, updateHealthQuestions, updateFollowUpNames, updateS5Names ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ---
    window.updateConfig = async () => {
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö...';
        statusElement.className = 'loading-text';
        
        for (const c of configData) {
            const updates = {
                max_s1: parseInt(document.getElementById(`c_s1_${c.id}`).value),
                max_s2: parseInt(document.getElementById(`c_s2_${c.id}`).value),
                max_s3: parseInt(document.getElementById(`c_s3_${c.id}`).value),
                max_s4: parseInt(document.getElementById(`c_s4_${c.id}`).value),
                max_s5: parseInt(document.getElementById(`c_s5_${c.id}`).value),
            };
            const { error } = await supabase.from('difficulty_config').update(updates).eq('id', c.id);
            if (error) {
                statusElement.className = 'error-text';
                statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Config ${c.difficulty_level} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`;
                return;
            }
        }
        await fetchAllData();
    };

    window.updateHealthQuestions = async () => { /* Logic for S4 Q text */
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å...';
        statusElement.className = 'loading-text';
        for (const q of healthQuestionsData) {
            const newText = document.getElementById(`q4_text_${q.id}`).value.trim();
            if (newText !== q.q_text) {
                const { error } = await supabase.from('health_questions_s4').update({ q_text: newText }).eq('id', q.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Q${q.q_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData();
    };
    
    window.updateFollowUpNames = async () => { /* Logic for S4 Follow-up Names */
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...';
        statusElement.className = 'loading-text';
        for (const q of followUpNamesData) {
            const newName = document.getElementById(`fu_name_${q.id}`).value.trim();
            if (newName !== q.step_name) {
                const { error } = await supabase.from('s4_follow_up_names').update({ step_name: newName }).eq('id', q.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Step ${q.step_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData(); 
    };
    
    window.updateS5Names = async () => { /* Logic for S5 Step Names */
        statusElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...';
        statusElement.className = 'loading-text';
        for (const s of s5StepsData) {
            const newName = document.getElementById(`s5_name_${s.id}`).value.trim();
            if (newName !== s.step_name) {
                const { error } = await supabase.from('scripts_s5').update({ step_name: newName }).eq('id', s.id);
                if (error) { statusElement.className = 'error-text'; statusElement.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Step ${s.step_index} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`; return; }
            }
        }
        await fetchAllData();
    };
    
    // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL (UPDATE AUDIO URL) ---
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô uploadAudio ‡πÅ‡∏•‡∏∞ uploadYesTriggerAudio ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    window.uploadAudio = async (fileInputId, table, column, index_col, index_val, statusId) => {
        const fileInput = document.getElementById(fileInputId);
        const uploadStatus = document.getElementById(statusId);
        const file = fileInput.files[0];

        if (!file) { uploadStatus.className = 'error-text'; uploadStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î'; return; }
        
        uploadStatus.className = 'loading-text';
        uploadStatus.textContent = `‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ${file.name}...`;

        const fileExtension = file.name.split('.').pop();
        const sectionPrefix = table.split('_')[1] || 'generic';
        const path = `customer_audio/${sectionPrefix}/${sectionPrefix}_${index_val}_${uuidv4()}.${fileExtension}`; 

        try {
            const { error: uploadError } = await supabase.storage
                .from('responses') 
                .upload(path, file, { upsert: true });
            if (uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage.from('responses').getPublicUrl(path);

            const updateObject = {};
            updateObject[column] = publicUrl;
            
            const { error: updateError } = await supabase
                .from(table)
                .update(updateObject)
                .eq(index_col, index_val);

            if (updateError) throw updateError;

            uploadStatus.className = 'success-text';
            uploadStatus.textContent = '‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
            
            await fetchAllData();

        } catch (err) {
            console.error('Upload or Update error:', err);
            uploadStatus.className = 'error-text';
            uploadStatus.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Bucket name ‡πÅ‡∏•‡∏∞ RLS policies (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ policy INSERT/UPDATE/SELECT/DELETE ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö anon).`;
        }
    };
    
    window.uploadYesTriggerAudio = async () => {
        if (!yesTriggerQ) {
             document.getElementById('uploadStatus').className = 'error-text';
             document.getElementById('uploadStatus').textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Yes Trigger ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
             return;
        }
        await window.uploadAudio('yesTriggerFileInput', 'health_questions_s4', 'yes_trigger_url', 'id', yesTriggerQ.id, 'uploadStatus');
    };

    // --- Initialize ---
    document.addEventListener('DOMContentLoaded', fetchAllData);
</script>
</body>
</html>
