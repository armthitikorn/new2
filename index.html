<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>E-Simulator Roleplay (Final Fixed)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
            -webkit-text-size-adjust: 100%;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { font-size: 28px; color: #d9534f; margin-bottom: 20px; }
        h2 { margin-top: 25px; font-size: 22px; color: #337ab7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        button { 
            margin: 10px 5px;
            padding: 12px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            width: 100%; 
            max-width: 300px;
            min-height: 50px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
            touch-action: manipulation;
        }
        button:active { transform: scale(0.98); }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; background-color: #ccc !important; color: #666 !important; }
        
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }
        
        .retry-audio-btn {
            background-color: #ffc107 !important;
            color: #333 !important;
            border: 2px solid #e0a800 !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .form-control {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
            font-size: 16px;
            background-color: #fff;
        }

        .difficulty-option {
            display: inline-block;
            margin: 5px;
            cursor: pointer;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
            font-size: 14px;
        }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #337ab7; color: white; border-color: #337ab7; font-weight: bold;
        }
        input[type="radio"] { display: none; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 9999; text-align: center; font-size: 18px;
        }
        .progress { width: 80%; max-width: 300px; margin-top: 20px; height: 10px; background-color: #333; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #28a745; transition: width 0.3s ease; }
        
        #certificate { border: 5px solid #333; padding: 20px; width: 90%; max-width: 600px; margin: 40px auto; text-align: center; display: none; background: #fff; }

        @media (max-width: 600px) {
            .container-box { padding: 15px; margin: 10px; width: auto; }
            h1 { font-size: 24px; }
            button { width: 100%; margin: 8px 0; }
        }
    </style>
</head>
<body>
    
    <div id="loadingOverlay">
        <div class="spinner-border" style="width: 3rem; height: 3rem; border: 4px solid white; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</h5>
        <div class="progress"><div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div></div>
    </div>

    <div class="container-box">
        <h1>üì± E-Simulator (Mobile Optimized)</h1>
        
        <div id="registrationSection">
            <h2 style="color: #333;">1. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            
            <div style="margin-bottom: 15px;">
                <input type="text" class="form-control" id="inputUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
            </div>
            
            <div style="margin-bottom: 15px;">
                <select class="form-control" id="inputProductType" required>
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô --</option>
                    <option value="health">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (Health)</option>
                    <option value="saving1">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå 1 (Saving1)</option>
                    <option value="saving2">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå 2 (Saving2)</option> 
                    <option value="retirement">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç (Retirement)</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <select class="form-control" id="inputUserGroup" required>
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏ö‡∏£‡∏° --</option>
                    <option value="‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢">‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ (Sales)</option>
                    <option value="‡∏ù‡πà‡∏≤‡∏¢ Agent">‡∏ù‡πà‡∏≤‡∏¢ Agent</option>
                    <option value="‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå">‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå (Trainer)</option>
                    <option value="‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <p style="font-weight: bold; margin-bottom: 5px;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</p>
                <div>
                    <input type="radio" id="diffEasy" name="difficulty" value="‡πÄ‡∏ô‡∏≠‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡πà" checked>
                    <label for="diffEasy" class="difficulty-option">‡πÄ‡∏ô‡∏≠‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡πà</label>
                    <input type="radio" id="diffHard" name="difficulty" value="‡∏ô‡∏¥‡∏ß‡πÑ‡∏•‡∏ã‡∏¥‡πà‡∏á‡∏™‡∏ï‡∏≤‡∏£‡πå">
                    <label for="diffHard" class="difficulty-option">‡∏ô‡∏¥‡∏ß‡πÑ‡∏•‡∏ã‡∏¥‡πà‡∏á‡∏™‡∏ï‡∏≤‡∏£‡πå</label>
                    <input type="radio" id="diffHarder" name="difficulty" value="‡∏£‡∏µ‡πÄ‡∏à‡πâ‡∏ô‡∏ó‡πå">
                    <label for="diffHarder" class="difficulty-option">‡∏£‡∏µ‡πÄ‡∏à‡πâ‡∏ô‡∏ó‡πå</label>
                </div>
            </div>
            
            <button id="startTestBtn" style="background-color: #28a745; color: white;">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            </button>
        </div>
        
        <div id="testSection" style="display: none;">
            
            <audio id="mainAudioPlayer" playsinline preload="auto"></audio>

            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (<span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <button id="recordBtn" style="background-color: #007bff; color: white;">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                <div id="manualPlayContainer_S1" style="display:none; margin-top:10px;"></div>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ï‡πà‡∏≠)</button>
                <p id="status" style="margin-top: 10px; color: #666;">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (Pitch)</h2>
                <button disabled id="pitchRecordBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5 (‡πÑ‡∏õ‡∏ï‡πà‡∏≠)</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Q <span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <button disabled id="startQBtn">üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
                <div id="manualPlayContainer_S2" style="display:none; margin-top:10px;"></div>
                <button disabled id="answerBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (<span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button disabled id="closeBtn">üéôÔ∏è 1. ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <div id="manualPlayContainer_S3" style="display:none; margin-top:10px;"></div>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</button>
                <p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section4Div" style="display: none;">
                <h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">Q1</span>)</h2>
                <div id="healthQuestionDisplay" style="margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; background-color: #ffeaea; border-radius: 8px;"></div>
                <div id="manualPlayContainer_S4" style="display:none; margin-top:10px;"></div>
                <button disabled id="answerHBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4</button>
                <p id="hStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (<span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <div id="registrationStepsDisplay" style="text-align: left; margin: 10px 0; padding: 10px; border: 1px solid #ccc; background-color: #f8f9fa; border-radius: 8px;">
                    <ol id="stepList" style="padding-left: 20px; font-size: 15px;"></ol>
                </div>
                <div id="manualPlayContainer_S5" style="display:none; margin-top:10px;"></div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏≠‡∏ö</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1>
                <p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πà</p>
                <h2 id="traineeName"></h2>
                <p>‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</p>
                <p><strong>‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (Simulator)</strong></p>
                <p style="margin-top: 20px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn" style="display:none;">üéì ‡∏î‡∏π‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        // --- Config & State ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        let mediaRecorder = null;
        let audioChunks = [];
        const USER_ID_KEY = 'roleplay_user_id';
        let currentUserId = localStorage.getItem(USER_ID_KEY) || uuidv4();
        localStorage.setItem(USER_ID_KEY, currentUserId);
        
        let allRecordings = []; 
        let lastCustomerAudioUrl = 'N/A';
        let selectedProductType = ''; 
        
        let turn = 0, qRound = 0, cRound = 0, currentHIndex = 0, followUpStep = 0, aRound = 0;
        let isFollowUpMode = false;
        let maxTurns, maxQ, maxC, maxH, maxFollowUp = 5, maxA; 
        
        let globalConfig = {}, globalS1Files = {}, globalS2Files = {}, globalS3Files = {}, globalS4Questions = {}, globalS4FollowUpNames = {}, globalS4FollowUpReplies = {}, globalS5Steps = {};
        let selectedRandomFiles = []; 
        
        // --- Utility: Unlock Audio for iOS ---
        const unlockAudioContext = () => {
            const audio = document.getElementById('mainAudioPlayer');
            if(audio) {
                audio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAGZGF0YQQAAAAAAA=='; 
                audio.play().then(() => {
                    console.log('üîä Audio Unlocked');
                    audio.pause();
                    audio.currentTime = 0;
                }).catch(e => console.log('Audio unlock failed (normal if no user gesture yet)'));
            }
        };

        // --- Data Fetching ---
        const fetchInitialData = async function() {
            document.getElementById('loadingOverlay').style.display = "flex";
            try {
                const { data: configData } = await window.supabase.from('difficulty_config').select('*');
                configData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5 });
                
                const fetchAndGroup = async (tableName, keyField, groupStore) => {
                    const { data, error } = await window.supabase.from(tableName).select('*').order(keyField, { ascending: true });
                    if (error) throw error;
                    data.forEach(item => {
                        (item.product_type || []).forEach(p => {
                            const product = p.toLowerCase().trim();
                            if (!groupStore[product]) groupStore[product] = [];
                            groupStore[product].push(item);
                        });
                    });
                };

                await fetchAndGroup('customer_replies_s1', 'turn_index', globalS1Files);
                await fetchAndGroup('questions_s2', 'q_index', globalS2Files);
                await fetchAndGroup('objections_s3', 'ob_index', globalS3Files);
                await fetchAndGroup('health_questions_s4', 'q_index', globalS4Questions);
                await fetchAndGroup('s4_follow_up_names', 'step_index', globalS4FollowUpNames);
                await fetchAndGroup('s4_follow_up_replies', 'step_index', globalS4FollowUpReplies);
                await fetchAndGroup('scripts_s5', 'step_index', globalS5Steps);

                document.getElementById('loadingOverlay').style.display = "none";
                return true; 
            } catch (error) { 
                alert(`Error loading data: ${error.message}`); 
                return false; 
            }
        }

        const prepareTurnFiles = function() {
            const diffRadios = document.getElementsByName('difficulty');
            let diff = "easy";
            for(let i=0; i<diffRadios.length; i++) { if(diffRadios[i].checked) diff = diffRadios[i].id === 'diffEasy' ? 'easy' : (diffRadios[i].id === 'diffHard' ? 'hard' : 'harder'); }

            const max = globalConfig[diff]?.S1 || 5; 
            let rawFiles = globalS1Files[selectedProductType] || [];
            
            const cleanFiles = rawFiles.filter(f => {
                const tags = f.product_type || [];
                if (selectedProductType === 'saving1' && tags.includes('saving2')) return false;
                if (selectedProductType === 'saving2' && tags.includes('saving1')) return false;
                return true;
            });

            selectedRandomFiles = [];
            for (let i = 1; i < max; i++) {
                const file = cleanFiles.find(f => f.turn_index === i && !f.is_finale);
                selectedRandomFiles.push(file ? file.audio_url : null);
            }
            const finale = cleanFiles.find(f => f.is_finale);
            selectedRandomFiles.push(finale ? finale.audio_url : null);
        }

        // --- Audio Player ---
        const playAudio = (url, statusEl, btnToEnable, manualContainerId) => {
            if (manualContainerId) document.getElementById(manualContainerId).innerHTML = '';
            
            if (!url) { 
                statusEl.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (No Audio)"; 
                if(btnToEnable) btnToEnable.disabled = false;
                return; 
            }

            statusEl.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
            const player = document.getElementById('mainAudioPlayer');
            player.src = url;
            
            player.onended = () => {
                lastCustomerAudioUrl = url;
                statusEl.textContent = "‚úÖ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
                if(btnToEnable) btnToEnable.disabled = false;
                if(manualContainerId) document.getElementById(manualContainerId).style.display = 'none';
            };

            const attemptPlay = player.play();
            if (attemptPlay !== undefined) {
                attemptPlay.then(() => {
                    statusEl.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
                }).catch(error => {
                    console.warn("Auto-play blocked:", error);
                    statusEl.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
                    if (manualContainerId) {
                        const container = document.getElementById(manualContainerId);
                        container.style.display = 'block';
                        container.innerHTML = `
                            <button class="retry-audio-btn" onclick="document.getElementById('mainAudioPlayer').play()">
                                üîä ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                            </button>
                        `;
                    }
                });
            }
        };

        // --- Logic Flows ---
        const endTurn = () => {
            if (turn < maxTurns) {
                turn++; document.getElementById("turnSpan").textContent = turn;
                const isFinal = (turn === maxTurns);
                const fileUrl = selectedRandomFiles[turn-1];
                const nextBtn = isFinal ? document.getElementById("nextRoundBtn") : document.getElementById("recordBtn");
                playAudio(fileUrl, document.getElementById("status"), nextBtn, 'manualPlayContainer_S1');
                if(isFinal) document.getElementById("recordBtn").disabled = true;
            }
        }
        
        const initSection1_5 = () => {
            document.getElementById('section1Div').style.display='none'; document.getElementById('section1_5Div').style.display='block';
            document.getElementById('pitchRecordBtn').disabled=false; 
            lastCustomerAudioUrl = 'S1.5 Pitch'; 
            document.getElementById('pitchStatus').textContent = "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á 1.5 Pitch"; 
        }

        const initSection2 = () => {
            document.getElementById('section1_5Div').style.display='none'; document.getElementById('section2Div').style.display='block';
            document.getElementById('startQBtn').disabled=false; qRound=0; 
            lastCustomerAudioUrl = 'S2 Start'; document.getElementById('qStatus').textContent = "‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"; 
        }
        
        const playS2 = () => {
            if (qRound >= maxQ) { 
                document.getElementById('qStatus').textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2"; 
                document.getElementById('nextSection3Btn').disabled = false; return; 
            }
            qRound++; document.getElementById("qRound").textContent = qRound;
            const file = (globalS2Files[selectedProductType] || []).find(f => f.q_index === qRound);
            playAudio(file?.audio_url, document.getElementById("qStatus"), document.getElementById("answerBtn"), 'manualPlayContainer_S2');
            if(qRound===1) document.getElementById("startQBtn").style.display = 'none';
        }
        
        const initSection3 = () => {
            document.getElementById('section2Div').style.display='none'; document.getElementById('section3Div').style.display='block';
            document.getElementById('closeBtn').disabled=false; cRound=0; document.getElementById('closeBtn').style.display='block';
            lastCustomerAudioUrl = 'S3 Start'; document.getElementById('cStatus').textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
        }

        const playS3 = () => {
            if (cRound >= maxC) { 
                document.getElementById("cStatus").textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3"; 
                document.getElementById("nextSection4Btn").disabled = false; 
                document.getElementById("replyBtn").disabled = true; 
                document.getElementById("closeBtn").style.display='none'; return; 
            }
            cRound++; document.getElementById("cRound").textContent = cRound;
            if(cRound===1) document.getElementById("closeBtn").style.display = 'none';
            const file = (globalS3Files[selectedProductType] || []).find(f => f.ob_index === cRound);
            playAudio(file?.audio_url, document.getElementById("cStatus"), document.getElementById("replyBtn"), 'manualPlayContainer_S3');
        }
        
        const initSection4 = () => {
            const isHealth = selectedProductType === 'health';
            const diffRadios = document.getElementsByName('difficulty');
            let diff = "easy";
            for(let i=0; i<diffRadios.length; i++) { if(diffRadios[i].checked) diff = diffRadios[i].id === 'diffEasy' ? 'easy' : (diffRadios[i].id === 'diffHard' ? 'hard' : 'harder'); }
            
            maxH = isHealth ? (globalConfig[diff]?.S4 || 5) : 1;
            document.getElementById('section3Div').style.display='none'; document.getElementById('section4Div').style.display='block';
            currentHIndex=0; isFollowUpMode=false; followUpStep=0; updateS4UI(); 
            document.getElementById('answerHBtn').disabled=false; document.getElementById('answerHBtn').style.display='block'; 
            if(window.followUpQBtn) window.followUpQBtn.style.display='none';
        }

        const playS4 = () => {
            document.getElementById('answerHBtn').disabled = true;
            const isHealth = selectedProductType === 'health';
            const isTrigger = isHealth ? (currentHIndex === 3) : (currentHIndex === 0);
            const qList = globalS4Questions[selectedProductType] || [];
            const currentQ = qList.find(q => q.q_index === (currentHIndex + 1));
            const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
            
            let url = NO_ANSWER_URL;
            if (isTrigger && currentQ && currentQ.yes_trigger_url) url = currentQ.yes_trigger_url;
            
            const statusEl = document.getElementById("hStatus");
            const player = document.getElementById('mainAudioPlayer');
            player.src = url;
            player.onended = () => {
                if (isTrigger) {
                    isFollowUpMode = true; followUpStep = 1; updateS4UI();
                    statusEl.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Follow-up)";
                    window.followUpQBtn.style.display = 'inline-block'; 
                    document.getElementById('answerHBtn').style.display = 'none'; 
                    window.followUpQBtn.disabled = false;
                } else {
                    currentHIndex++;
                    if(currentHIndex < maxH) { updateS4UI(); statusEl.textContent = "‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"; document.getElementById('answerHBtn').disabled = false; }
                    else { statusEl.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4"; document.getElementById('nextSection5Btn').disabled = false; }
                }
                document.getElementById('manualPlayContainer_S4').style.display = 'none';
            };
            player.play().catch(e => {
                statusEl.textContent = "‚ö†Ô∏è ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
                const cont = document.getElementById('manualPlayContainer_S4');
                cont.style.display='block';
                cont.innerHTML = `<button class="retry-audio-btn" onclick="document.getElementById('mainAudioPlayer').play()">üîä ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</button>`;
            });
        }

        const playS4FollowUp = () => {
            window.followUpQBtn.disabled = true;
            const repliesList = globalS4FollowUpReplies[selectedProductType] || [];
            const fileData = repliesList.find(f => f.step_index === followUpStep);
            const player = document.getElementById('mainAudioPlayer');
            const statusEl = document.getElementById("hStatus");
            const handleFollowUpEnd = () => {
                followUpStep++;
                if (followUpStep > maxFollowUp) {
                    isFollowUpMode = false; currentHIndex++;
                    if(currentHIndex < maxH) { 
                        updateS4UI(); window.followUpQBtn.style.display = 'none'; 
                        document.getElementById('answerHBtn').style.display = 'inline-block'; 
                        document.getElementById('answerHBtn').disabled = false; statusEl.textContent = "‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å"; 
                    } else { statusEl.textContent = "üéâ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4"; window.followUpQBtn.style.display = 'none'; document.getElementById('nextSection5Btn').disabled = false; }
                } else { updateS4UI(); window.followUpQBtn.disabled = false; statusEl.textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠ ${followUpStep}`; }
                document.getElementById('manualPlayContainer_S4').style.display = 'none';
            };
            if (fileData && fileData.customer_audio_url) {
                player.src = fileData.customer_audio_url;
                statusEl.textContent = `üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠ ${followUpStep}...`;
                player.onended = handleFollowUpEnd;
                player.play().catch(e => {
                    statusEl.textContent = "‚ö†Ô∏è ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
                    const cont = document.getElementById('manualPlayContainer_S4');
                    cont.style.display='block';
                    cont.innerHTML = `<button class="retry-audio-btn" onclick="document.getElementById('mainAudioPlayer').play()">üîä ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</button>`;
                });
            } else { player.src = ""; setTimeout(handleFollowUpEnd, 1000); }
        }
        
        const initSection5 = () => {
            document.getElementById('section4Div').style.display='none'; document.getElementById('section5Div').style.display='block';
            const diffRadios = document.getElementsByName('difficulty');
            let diff = "easy";
            for(let i=0; i<diffRadios.length; i++) { if(diffRadios[i].checked) diff = diffRadios[i].id === 'diffEasy' ? 'easy' : (diffRadios[i].id === 'diffHard' ? 'hard' : 'harder'); }
            maxA = globalConfig[diff]?.S5 || 7; 
            document.getElementById('maxASpan').textContent=maxA;
            aRound=1; document.getElementById('aRound').textContent=1; renderRegistrationSteps(); updateStepHighlight(1);
            document.getElementById('answerABtn').disabled=false; 
            document.getElementById('answerABtn').textContent=`üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1`;
        }

        const playS5 = () => {
            const step = (globalS5Steps[selectedProductType] || []).find(s => s.step_index === aRound);
            const nextBtn = document.getElementById("answerABtn");
            nextBtn.disabled = true;
            const player = document.getElementById('mainAudioPlayer');
            player.src = step?.customer_audio_url;
            player.onended = () => {
                lastCustomerAudioUrl = step?.customer_audio_url;
                if (aRound >= maxA) { document.getElementById('aStatus').textContent = "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!"; document.getElementById('finalSaveBtn').disabled = false; updateStepHighlight(99); }
                else { aRound++; document.getElementById('aRound').textContent = aRound; updateStepHighlight(aRound); nextBtn.textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${aRound}`; nextBtn.disabled = false; }
                document.getElementById('manualPlayContainer_S5').style.display = 'none';
            };
            player.play().catch(e => {
                 document.getElementById('aStatus').textContent = "‚ö†Ô∏è ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
                 const cont = document.getElementById('manualPlayContainer_S5');
                 cont.style.display='block';
                 cont.innerHTML = `<button class="retry-audio-btn" onclick="document.getElementById('mainAudioPlayer').play()">üîä ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö</button>`;
            });
        }

        // --- UI Updates ---
        const updateS4UI = () => {
            const d = document.getElementById('healthQuestionDisplay');
            if (isFollowUpMode) {
                const fList = globalS4FollowUpNames[selectedProductType] || [];
                const fName = fList.find(f => f.step_index === followUpStep)?.step_name || `Q${followUpStep}`;
                document.getElementById('hQName').textContent = `Follow-up ${followUpStep}`; 
                d.innerHTML = `<p>‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: <strong>${fName}</strong></p>`;
                window.followUpQBtn.textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥`;
            } else if (currentHIndex < maxH) {
                const qList = globalS4Questions[selectedProductType] || [];
                const qText = qList.find(q => q.q_index === currentHIndex+1)?.q_text || `Q${currentHIndex+1}`;
                document.getElementById('hQName').textContent = `Q${currentHIndex+1}`; 
                d.innerHTML = `<p>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å: <strong>${qText}</strong></p>`;
                document.getElementById('answerHBtn').textContent = `üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ${currentHIndex+1}`;
            } else { d.innerHTML = "<p>‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</p>"; }
        }

        const renderRegistrationSteps = () => {
            const list = document.getElementById('stepList'); list.innerHTML = '';
            (globalS5Steps[selectedProductType] || []).forEach((s,i) => {
                const li = document.createElement('li'); li.id=`reg-step-${i+1}`; li.textContent=s.step_name; list.appendChild(li);
            });
        }
        const updateStepHighlight = (step) => {
            document.querySelectorAll('#stepList li').forEach(li => { li.style.fontWeight='normal'; li.style.color='#333'; });
            const li = document.getElementById(`reg-step-${step}`); if(li){ li.style.fontWeight='bold'; li.style.color='#007bff'; }
        }

        // --- RECORDING ---
        const toggleRecording = async (type) => {
            let btn, status, nextAction, part, qNum, qText, url = lastCustomerAudioUrl;
            
            if (type===1) { btn=document.getElementById("recordBtn"); status=document.getElementById("status"); nextAction=endTurn; part=1; qNum=turn+1; qText=`S1 Turn ${qNum}`; }
            else if (type===2) { btn=document.getElementById("answerBtn"); status=document.getElementById("qStatus"); nextAction=playS2; part=2; qNum=qRound; qText=`S2 Q${qNum}`; }
            else if (type===3) { btn=document.getElementById("closeBtn"); status=document.getElementById("cStatus"); nextAction=playS3; part=3; qNum=0; qText=`S3 Closing`; url="SCRIPT"; }
            else if (type===4) { btn=document.getElementById("replyBtn"); status=document.getElementById("cStatus"); nextAction=playS3; part=3; qNum=cRound; qText=`S3 Objection ${qNum}`; }
            else if (type===5) { btn=document.getElementById("answerHBtn"); status=document.getElementById("hStatus"); nextAction=playS4; part=4; qNum=currentHIndex+1; qText=`S4 Q${qNum}`; }
            else if (type===6) { btn=document.getElementById("answerABtn"); status=document.getElementById("aStatus"); nextAction=playS5; part=5; qNum=aRound; qText=`S5 Step ${qNum}`; }
            else if (type===7) { btn=window.followUpQBtn; status=document.getElementById("hStatus"); nextAction=playS4FollowUp; part=4; qNum=(currentHIndex+1)*10+followUpStep; qText=`S4 FollowUp ${followUpStep}`; }
            else if (type===8) { btn=document.getElementById("pitchRecordBtn"); status=document.getElementById("pitchStatus"); nextAction=() => { document.getElementById("nextSection2Btn").disabled=false; btn.disabled=true; }; part=15; qNum=1; qText="S1.5 Pitch"; url="SCRIPT"; }

            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    unlockAudioContext();
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream); 
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' }); 
                        allRecordings.push({ audioBlob: blob, part, qNum, qText, customerAudioUrl: url });
                        status.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
                        btn.textContent = "üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; btn.disabled = true;
                        stream.getTracks().forEach(t => t.stop());
                        mediaRecorder = null;
                        setTimeout(nextAction, 500); 
                    };
                    mediaRecorder.start();
                    btn.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; status.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
                } catch (e) { alert("Mic Error: " + e.message); }
            } else { mediaRecorder.stop(); }
        }

        // --- UPDATED: uploadAll with Professional Database Mapping ---
        const uploadAll = async () => {
            document.getElementById('loadingOverlay').style.display = "flex";
            document.getElementById('loadingText').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...";
            
            // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            const traineeName = document.getElementById("inputUserName").value;
            const groupName = document.getElementById("inputUserGroup").value;
            const staffLevel = document.querySelector('input[name="difficulty"]:checked').value;
            
            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß" (One Row per User)
            let updatePayload = {
                user_id: currentUserId,
                name: traineeName,
                user_group: groupName,
                staff_level: staffLevel,
                insurance_type: selectedProductType,
                created_at: new Date()
            };

            let uploadCount = 0;
            const totalToUpload = allRecordings.length;

            for (let i = 0; i < totalToUpload; i++) {
                const rec = allRecordings[i];
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î Storage: userId / Step / UUID.webm
                const fileName = `${currentUserId}/S${rec.part}/${uuidv4()}.webm`;
                
                const { error: upErr } = await window.supabase.storage.from('responses').upload(fileName, rec.audioBlob);
                
                if(!upErr) {
                    const { data: { publicUrl } } = window.supabase.storage.from('responses').getPublicUrl(fileName);
                    
                    // --- ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Mapping ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå SQL ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ ---
                    if (rec.part === 1) updatePayload.s1_audio_url = publicUrl;
                    else if (rec.part === 15) updatePayload.s1_5_audio_url = publicUrl;
                    else if (rec.part === 2) updatePayload.s2_audio_url = publicUrl;
                    else if (rec.part === 3) updatePayload.s3_audio_url = publicUrl;
                    else if (rec.part === 4) updatePayload.s4_audio_url = publicUrl;
                    else if (rec.part === 5) updatePayload.s5_audio_url = publicUrl;
                    
                    uploadCount++;
                }
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Progress Bar
                document.getElementById('uploadProgressBar').style.width = `${((i + 1) / totalToUpload) * 100}%`;
            }

            // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á submissions (‡πÉ‡∏ä‡πâ upsert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
            const { error: dbErr } = await window.supabase
                .from('submissions')
                .upsert([updatePayload], { onConflict: 'user_id' });

            document.getElementById('loadingOverlay').style.display = "none";
            
            if(!dbErr) { 
                document.getElementById("finalSaveBtn").textContent = "‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; 
                document.getElementById('certificate').style.display = 'block';
                document.getElementById('traineeName').textContent = traineeName;
                document.getElementById('issueDate').textContent = new Date().toLocaleDateString('th-TH');
                document.getElementById("certificate").scrollIntoView();
            } else { 
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + dbErr.message); 
                document.getElementById("finalSaveBtn").disabled = false; 
            }
        }

        const startTest = function() {
            const userName = document.getElementById('inputUserName').value.trim();
            const inputProductType = document.getElementById('inputProductType').value; 
            const inputUserGroup = document.getElementById('inputUserGroup').value;     
            if (!userName || !inputUserGroup || !inputProductType) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); return; }
            unlockAudioContext();
            selectedProductType = inputProductType;
            const diffRadios = document.getElementsByName('difficulty');
            let diff = "easy";
            for(let i=0; i<diffRadios.length; i++) { if(diffRadios[i].checked) diff = diffRadios[i].id === 'diffEasy' ? 'easy' : (diffRadios[i].id === 'diffHard' ? 'hard' : 'harder'); }
            const config = globalConfig[diff];
            maxTurns = config.S1; maxQ = config.S2; maxC = config.S3; maxH = config.S4; maxA = config.S5; 
            maxFollowUp = globalS4FollowUpNames[selectedProductType] ? globalS4FollowUpNames[selectedProductType].length : 5;
            document.getElementById("maxTurnSpan").textContent = maxTurns; document.getElementById("maxQSpan").textContent = maxQ;
            document.getElementById("maxCSpan").textContent = maxC; document.getElementById("maxASpan").textContent = maxA; 
            document.getElementById("registrationSection").style.display = 'none'; document.getElementById("testSection").style.display = 'block';
            document.getElementById('section1Div').style.display = 'block';
            if (!globalS1Files[selectedProductType]) { alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Product ‡∏ô‡∏µ‡πâ"); return; }
            prepareTurnFiles(); document.getElementById("status").textContent = `üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô 1)`;
        }

        const init = async () => {
            if (document.getElementById('nextSection5Btn')) {
                window.followUpQBtn = document.createElement('button');
                window.followUpQBtn.textContent = 'üéôÔ∏è ‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'; window.followUpQBtn.style.display = 'none';
                window.followUpQBtn.className = 'btn-primary'; 
                window.followUpQBtn.style.backgroundColor = '#17a2b8'; window.followUpQBtn.style.color = 'white';
                document.getElementById('nextSection5Btn').parentNode.insertBefore(window.followUpQBtn, document.getElementById('nextSection5Btn'));
            }
            document.getElementById("startTestBtn").onclick = startTest;
            document.getElementById("recordBtn").onclick = () => toggleRecording(1);
            document.getElementById("nextRoundBtn").onclick = initSection1_5;
            document.getElementById("pitchRecordBtn").onclick = () => toggleRecording(8);
            document.getElementById("nextSection2Btn").onclick = initSection2;
            document.getElementById("startQBtn").onclick = playS2;
            document.getElementById("answerBtn").onclick = () => toggleRecording(2);
            document.getElementById("nextSection3Btn").onclick = initSection3;
            document.getElementById("closeBtn").onclick = () => toggleRecording(3);
            document.getElementById("replyBtn").onclick = () => toggleRecording(4);
            document.getElementById("nextSection4Btn").onclick = initSection4;
            document.getElementById("answerHBtn").onclick = () => toggleRecording(5);
            if(window.followUpQBtn) window.followUpQBtn.onclick = () => toggleRecording(7);
            document.getElementById("nextSection5Btn").onclick = initSection5;
            document.getElementById("answerABtn").onclick = () => toggleRecording(6);
            document.getElementById("finalSaveBtn").onclick = uploadAll;
            await fetchInitialData();
        };
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
