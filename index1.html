<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û - Database Driven)</title>
    
    <style>
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            text-align: center; 
            background-color: #f4f7f6;
        }
        .container-box {
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        h1 { 
            font-size: 32px;
            color: #d9534f;
            margin-bottom: 20px;
        }
        h2 { 
            margin-top: 25px;
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button { 
            margin: 10px 5px;
            padding: 12px 24px; 
            font-size: 18px; 
            cursor: pointer; 
            width: auto; 
            min-height: 48px;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #finalSaveBtn { background-color: #007bff; color: white; font-weight: bold; }
        #finalSaveBtn.done { background-color: #28a745; }

        .form-control {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            margin-top: 5px;
            text-align: center;
            font-size: 16px;
        }
        .difficulty-option {
            display: inline-block;
            margin: 8px;
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #ccc;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .difficulty-option:hover { border-color: #337ab7; }
        input[type="radio"]:checked + .difficulty-option {
            background-color: #337ab7;
            color: white;
            border-color: #337ab7;
            font-weight: bold;
        }
        input[type="radio"] { display: none; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); color: white; display: none; 
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 1000; text-align: center; font-size: 20px;
        }
        .spinner-border { width: 3rem; height: 3rem; border: 0.25em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        .progress { width: 80%; max-width: 400px; margin-top: 20px; height: 15px; background-color: #e9ecef; border-radius: 0.25rem; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; transition: width 0.6s ease; }
        
        #certificate { border: 5px solid #333; padding: 40px; width: 90%; max-width: 800px; margin: 40px auto; text-align: center; display: none; }
        
        @media (max-width: 600px) {
            .container-box { padding: 15px; margin: 0 10px; }
            h1 { font-size: 28px; }
            h2 { font-size: 20px; }
            button { padding: 10px 20px; font-size: 16px; width: 95%; }
            .difficulty-option { margin: 5px; padding: 8px 15px; }
        }
    </style>
</head>
<body>
    
    <div id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loadingText" class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£...</h5>
        <div class="progress" role="progressbar"><div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div></div>
    </div>

    <div class="container-box">
        <h1>E-Simulator Roleplay (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û)</h1>
        
        <div id="registrationSection">
            <h2 style="color: #333;">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <div style="margin-bottom: 20px;">
                <label for="inputUserName" style="font-weight: bold; display: block; margin-bottom: 10px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                <input type="text" class="form-control" id="inputUserName" required>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="inputUserGroup" style="font-weight: bold; display: block; margin-bottom: 10px;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</label>
                <select class="form-control" id="inputUserGroup" required>
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                    <option value="Nursery">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏≠‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡∏µ‡πà</option>
                    <option value="NewTSRsOnboarding">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs On boarding</option>
                    <option value="NewTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° New TSRs</option>
                    <option value="ExistingTSRs">‡∏Å‡∏•‡∏∏‡πà‡∏° TSRs existing</option>
                </select>
            </div>
            <div style="margin-bottom: 30px;">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å:</label>
                <div>
                    <input type="radio" id="diffEasy" name="difficulty" value="easy" checked>
                    <label for="diffEasy" class="difficulty-option">‡∏á‡πà‡∏≤‡∏¢ (Easy)</label>
                    <input type="radio" id="diffHard" name="difficulty" value="hard">
                    <label for="diffHard" class="difficulty-option">‡∏¢‡∏≤‡∏Å (Hard)</label>
                    <input type="radio" id="diffHarder" name="difficulty" value="harder">
                    <label for="diffHarder" class="difficulty-option">‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô (Harder)</label>
                </div>
            </div>
            <button id="startTestBtn" style="background-color: #28a745; color: white;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            <hr>
        </div>
        
        <div id="testSection" style="display: none;">
            <div id="section1Div">
                <h2>üó£Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (T<span id="turnSpan">1</span>/<span id="maxTurnSpan">5</span>)</h2>
                <audio id="customerAudio"></audio>
                <button id="recordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
                <button disabled id="nextRoundBtn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5)</button>
                <p id="status">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section1_5Div" style="display: none;">
                <h2>üõí ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ (Pitch)</h2>
                <button disabled id="pitchRecordBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</button>
                <button disabled id="nextSection2Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1.5 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2)</button>
                <p id="pitchStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section2Div" style="display: none;">
                <h2>‚ùì ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Q<span id="qRound">1</span>/<span id="maxQSpan">10</span>)</h2>
                <audio id="questionAudio"></audio>
                <button disabled id="startQBtn">üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
                <button disabled id="answerBtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                <button disabled id="nextSection3Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3)</button>
                <p id="qStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section3Div" style="display: none;">
                <h2>üí∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="cRound">1</span>/<span id="maxCSpan">5</span>)</h2>
                <button disabled id="closeBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <audio id="objectionAudio"></audio>
                <button disabled id="replyBtn">üéôÔ∏è 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á</button>
                <button disabled id="nextSection4Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4)</button>
                <p id="cStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section4Div" style="display: none;">
                <h2>üè• ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (<span id="hQName">Q1</span>)</h2>
                <div id="healthQuestionDisplay" style="margin: 15px 0; padding: 15px; border: 1px dashed #d9534f; border-radius: 8px; background-color: #ffeaea; font-weight: bold; font-size: 18px; color: #333;"></div>
                <audio id="healthAudio"></audio>
                <button disabled id="answerHBtn">üéôÔ∏è 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
                <button disabled id="nextSection5Btn">‚úÖ ‡∏à‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 (‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5)</button>
                <p id="hStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="section5Div" style="display: none;">
                <h2>ü§ù ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô <span id="aRound">1</span>/<span id="maxASpan">7</span>)</h2>
                <audio id="agreementAudio"></audio>
                <div id="registrationStepsDisplay" style="text-align: left; margin: 15px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f8f9fa;">
                    <ol id="stepList" style="padding-left: 20px; font-size: 16px;"></ol>
                </div>
                <button disabled id="answerABtn">üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button> 
                <button disabled id="finalSaveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                <p id="aStatus">‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                <hr>
            </div>

            <div id="certificate">
                <h1>‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡∏¢‡∏ö‡∏±‡∏ï‡∏£</h1><h2 id="traineeName"></h2>
                <p>‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</p>
                <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="issueDate"></span></p>
            </div>
            <button id="certBtn">üéì ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        import { v4 as uuidv4 } from 'https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/esm-browser/index.js';

        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        window.supabase = createClient(supabaseUrl, supabaseKey);

        const CURRENT_PRODUCT_ID = 'Health'; 
        // üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏£‡πå‡∏Å‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ["Health", "all"]
        const FILTER_TAGS = ['Health', 'all'];

        let mediaRecorder = null, currentUserId = null;
        const USER_ID_KEY = 'roleplay_user_id';
        let allRecordings = [], lastCustomerAudioUrl = 'N/A';
        let turn=0, qRound=0, cRound=0, currentHIndex=0, isFollowUpMode=false, followUpStep=0, aRound=0;
        let selectedDisease = null;
        let maxTurns, maxQ, maxC, maxH, maxFollowUp, maxA;
        let globalConfig={}, globalS1Files=[], globalS2Files=[], globalS3Files=[], globalS4Questions=[], globalS4FollowUpNames=[], globalS4FollowUpReplies=[], globalS5Steps=[];
        const NO_ANSWER_URL = "https://wzwyotzzxycqfwercakh.supabase.co/storage/v1/object/public/responses/part1/P1Q3/health5_P1_P1Q3_1762340907852.webm"; 
        let audioCache={}, selectedRandomFiles=[];

        // --- 1. Fetch Data (UPDATED for Array Column) ---
        const fetchInitialData = async function() {
            window.loadingOverlay.style.display = "flex";
            window.loadingText.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;
            try {
                // Config
                const { data: cData } = await window.supabase.from('difficulty_config').select('*');
                cData.forEach(c => globalConfig[c.difficulty_level] = { S1: c.max_s1, S2: c.max_s2, S3: c.max_s3, S4: c.max_s4, S5: c.max_s5 });

                // Fetch S1-S5 using .overlaps()
                const { data: s1 } = await window.supabase.from('customer_replies_s1').select('*').overlaps('product_type', FILTER_TAGS).order('turn_index');
                globalS1Files = s1 || [];

                const { data: s2 } = await window.supabase.from('questions_s2').select('*').overlaps('product_type', FILTER_TAGS).order('q_index');
                globalS2Files = s2 || [];

                const { data: s3 } = await window.supabase.from('objections_s3').select('*').overlaps('product_type', FILTER_TAGS).order('ob_index');
                globalS3Files = s3 || [];

                const { data: s4 } = await window.supabase.from('health_questions_s4').select('*').overlaps('product_type', FILTER_TAGS).order('q_index');
                globalS4Questions = (s4||[]).map(q => q.q_text);
                selectedDisease = (s4||[]).find(q => q.is_yes_trigger) || {name: '‡πÇ‡∏£‡∏Ñ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', yes_trigger_url: NO_ANSWER_URL};
                
                const { data: s4n } = await window.supabase.from('s4_follow_up_names').select('*').overlaps('product_type', FILTER_TAGS).order('step_index');
                globalS4FollowUpNames = s4n || [];

                const { data: s4r } = await window.supabase.from('s4_follow_up_replies').select('*').overlaps('product_type', FILTER_TAGS).order('step_index');
                globalS4FollowUpReplies = s4r || [];

                const { data: s5 } = await window.supabase.from('scripts_s5').select('*').overlaps('product_type', FILTER_TAGS).order('step_index');
                globalS5Steps = s5 || [];

                preloadCriticalAudio();
                window.loadingOverlay.style.display = "none";
                return true;
            } catch (err) {
                console.error(err);
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
                window.loadingOverlay.style.display = "none";
                return false;
            }
        };

        const preloadCriticalAudio = () => {
             const urls = [...globalS1Files, ...globalS2Files, ...globalS3Files, ...globalS4FollowUpReplies, ...globalS5Steps].map(f => f.audio_url || f.customer_audio_url);
             if(selectedDisease) urls.push(selectedDisease.yes_trigger_url);
             urls.push(NO_ANSWER_URL);
             urls.forEach(u => { if(u) new Audio(u).load(); });
        };
        const getCachedAudio = (url) => new Audio(url);

        const prepareTurnFiles = () => {
            const diff = document.querySelector('input[name="difficulty"]:checked').value;
            const max = globalConfig[diff]?.S1 || 5;
            const finale = globalS1Files.find(f => f.is_finale);
            const pool = globalS1Files.filter(f => !f.is_finale);
            selectedRandomFiles = pool.slice(0, max-1).map(f=>f.audio_url);
            if(finale) selectedRandomFiles.push(finale.audio_url);
        };

        // --- Flow Logic ---
        window.startTest = () => {
            const diff = document.querySelector('input[name="difficulty"]:checked').value;
            const cfg = globalConfig[diff];
            if(!cfg) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Config ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å‡∏ô‡∏µ‡πâ"); return; }
            
            maxTurns=cfg.S1; maxQ=cfg.S2; maxC=cfg.S3; maxH=cfg.S4; maxA=cfg.S5; 
            maxFollowUp=globalS4FollowUpNames.length;
            
            document.getElementById('maxTurnSpan').textContent = maxTurns;
            document.getElementById('maxQSpan').textContent = maxQ;
            document.getElementById('maxCSpan').textContent = maxC;
            document.getElementById('maxASpan').textContent = maxA;

            prepareTurnFiles();
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('testSection').style.display = 'block';
            document.getElementById('section1Div').style.display = 'block';
            window.s1StatusElement.textContent = `üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß (T1/${maxTurns})`;
        };

        // --- Section 1 ---
        window.endTurn = () => {
            if(turn < maxTurns) {
                turn++; document.getElementById('turnSpan').textContent = turn;
                const url = selectedRandomFiles[turn-1];
                const audio = getCachedAudio(url);
                window.s1StatusElement.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...";
                audio.play();
                audio.onended = () => {
                    if(turn === maxTurns) {
                        window.nextRoundBtn.disabled = false; window.recordBtn.disabled = true;
                        window.s1StatusElement.textContent = "‚úÖ ‡∏à‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1 ‡πÅ‡∏•‡πâ‡∏ß";
                    } else {
                        window.s1StatusElement.textContent = "üé§ ‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß";
                        window.recordBtn.disabled = false;
                    }
                };
                lastCustomerAudioUrl = url;
            }
        };

        // --- Section 2 ---
        window.playQ = () => {
            if(qRound >= maxQ) { window.nextSection3Btn.disabled = false; return; }
            qRound++; document.getElementById('qRound').textContent = qRound;
            const url = globalS2Files[qRound-1]?.audio_url;
            if(!url) return;
            const audio = getCachedAudio(url);
            window.s2StatusElement.textContent = "üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°...";
            audio.play();
            audio.onended = () => { window.answerBtn.disabled=false; };
            lastCustomerAudioUrl = url;
            window.startQBtn.disabled = true;
        };
        window.nextQLogic = () => {
            if(qRound < maxQ) {
                window.startQBtn.disabled = false;
                window.s2StatusElement.textContent = "‡∏Å‡∏î‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
            } else {
                window.nextSection3Btn.disabled = false;
                window.s2StatusElement.textContent = "‚úÖ ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ä‡πà‡∏ß‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
            }
        };

        // --- Section 3 ---
        window.playObj = () => {
            if(cRound >= maxC) { window.nextSection4Btn.disabled = false; window.replyBtn.disabled=true; return; }
            cRound++; document.getElementById('cRound').textContent = cRound;
            const url = globalS3Files[cRound-1]?.audio_url;
            if(!url) return;
            const audio = getCachedAudio(url);
            window.s3StatusElement.textContent = "üîä ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á...";
            audio.play();
            audio.onended = () => { window.replyBtn.disabled=false; };
            lastCustomerAudioUrl = url;
        };

        // --- Section 4 (Health) ---
        window.initSection4 = () => {
            hideAllSec(); document.getElementById('section4Div').style.display='block';
            currentHIndex=0; updateHUI(); window.answerHBtn.disabled=false;
        };
        window.playHResponse = () => {
            // Logic: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠ Trigger (‡πÄ‡∏ä‡πà‡∏ô Q4=Index3) ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö YES
            const isYesTrigger = (currentHIndex === 3); 
            const url = isYesTrigger ? selectedDisease.yes_trigger_url : NO_ANSWER_URL;
            
            const audio = getCachedAudio(url);
            window.hStatusElement.textContent = "üîä ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö...";
            audio.play();
            audio.onended = () => {
                if(isYesTrigger) {
                    isFollowUpMode = true; followUpStep=1; updateHUI();
                    window.answerHBtn.style.display = 'none';
                    window.followUpQBtn.style.display = 'inline-block';
                    window.followUpQBtn.disabled = false;
                } else {
                    currentHIndex++; 
                    if(currentHIndex >= maxH) { window.nextSection5Btn.disabled=false; window.answerHBtn.disabled=true; }
                    else { updateHUI(); window.answerHBtn.disabled=false; }
                }
            };
            lastCustomerAudioUrl = url;
        };
        window.playFollowUpReply = () => {
            const url = globalS4FollowUpReplies[followUpStep-1]?.customer_audio_url;
            const audio = getCachedAudio(url);
            window.hStatusElement.textContent = "üîä ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...";
            audio.play();
            audio.onended = () => {
                followUpStep++;
                if(followUpStep > maxFollowUp) {
                    isFollowUpMode=false; currentHIndex++;
                    window.followUpQBtn.style.display='none';
                    window.answerHBtn.style.display='inline-block';
                    if(currentHIndex >= maxH) { window.nextSection5Btn.disabled=false; window.answerHBtn.disabled=true;}
                    else { updateHUI(); window.answerHBtn.disabled=false; }
                } else {
                    updateHUI(); window.followUpQBtn.disabled=false;
                }
            };
            lastCustomerAudioUrl = url;
        };

        // --- Section 5 ---
        window.initSection5 = () => {
            hideAllSec(); document.getElementById('section5Div').style.display='block';
            aRound=1; renderRegSteps(); window.answerABtn.disabled=false;
            document.getElementById('aRound').textContent = aRound;
        };
        window.playRegReply = () => {
            const url = globalS5Steps[aRound-1]?.customer_audio_url;
            const audio = getCachedAudio(url);
            window.aStatusElement.textContent = "üîä ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö...";
            audio.play();
            audio.onended = () => {
                aRound++;
                if(aRound > maxA) { window.finalSaveBtn.disabled=false; window.answerABtn.disabled=true; }
                else { 
                    document.getElementById('aRound').textContent = aRound;
                    renderRegSteps();
                    window.answerABtn.disabled=false; 
                }
            };
            lastCustomerAudioUrl = url;
        };

        // --- Recording & Saving ---
        window.toggleRecording = async (type) => {
            let btn, nextAction;
            if(type===1) { btn=window.recordBtn; nextAction=endTurn; }
            if(type===8) { btn=window.pitchRecordBtn; nextAction=()=>{ window.nextSection2Btn.disabled=false; }; }
            if(type===2) { btn=window.answerBtn; nextAction=nextQLogic; }
            if(type===3) { btn=window.closeBtn; nextAction=playObj; }
            if(type===4) { btn=window.replyBtn; nextAction=playObj; }
            if(type===5) { btn=window.answerHBtn; nextAction=playHResponse; }
            if(type===7) { btn=window.followUpQBtn; nextAction=playFollowUpReply; }
            if(type===6) { btn=window.answerABtn; nextAction=playRegReply; }

            if(!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                    mediaRecorder = new MediaRecorder(stream);
                    let chunks=[];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, {type:'audio/webm'});
                        allRecordings.push({ 
                            blob: blob, 
                            part: type, 
                            qNum: (type===1?turn: (type===2?qRound: (type===4?cRound:0))),
                            customerUrl: lastCustomerAudioUrl 
                        });
                        btn.textContent = "üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; btn.disabled=true;
                        setTimeout(nextAction, 500);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start();
                    btn.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î";
                } catch(e) { alert("Mic Error: "+e.message); }
            } else {
                mediaRecorder.stop();
            }
        };

        window.saveAllRecordings = async () => {
            window.loadingOverlay.style.display='flex';
            window.loadingText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
            
            const userId = currentUserId || uuidv4();
            const userName = window.inputUserName.value;
            let successCount = 0;

            for(let i=0; i<allRecordings.length; i++) {
                const rec = allRecordings[i];
                const fileName = `${userId}/${rec.part}/${Date.now()}.webm`;
                const {error} = await window.supabase.storage.from('responses').upload(fileName, rec.blob);
                if(!error) {
                    const {data:{publicUrl}} = window.supabase.storage.from('responses').getPublicUrl(fileName);
                    await window.supabase.from('submissions').insert({
                        user_id: userId,
                        name: userName,
                        part_number: rec.part,
                        question_number: rec.qNum,
                        audio_url: publicUrl,
                        insurance_type: 'Health',
                        customer_audio_url: rec.customerUrl
                    });
                    successCount++;
                }
            }
            window.loadingOverlay.style.display='none';
            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount}/${allRecordings.length} ‡πÑ‡∏ü‡∏•‡πå`);
            document.getElementById('certificate').style.display='block';
            document.getElementById('traineeName').textContent = userName;
            document.getElementById('issueDate').textContent = new Date().toLocaleDateString();
            window.finalSaveBtn.classList.add('done');
        };

        // --- Helpers ---
        const hideAllSec = () => ['section1Div','section1_5Div','section2Div','section3Div','section4Div','section5Div'].forEach(id => document.getElementById(id).style.display='none');
        const updateHUI = () => {
            const d = document.getElementById('healthQuestionDisplay');
            if(isFollowUpMode) d.innerHTML = `<b>‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</b> ${globalS4FollowUpNames[followUpStep-1]?.step_name}`;
            else d.innerHTML = `<b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å:</b> ${globalS4Questions[currentHIndex]}`;
        };
        const renderRegSteps = () => {
            const ol = document.getElementById('stepList'); ol.innerHTML='';
            globalS5Steps.forEach((s,i) => {
                const li = document.createElement('li'); li.textContent = s.step_name;
                if(i+1 === aRound) li.style.fontWeight="bold";
                ol.appendChild(li);
            });
        };

        // --- Init ---
        const init = async () => {
            currentUserId = localStorage.getItem(USER_ID_KEY) || uuidv4();
            localStorage.setItem(USER_ID_KEY, currentUserId);

            // Bind Elements
            window.s1StatusElement = document.getElementById('status');
            window.s2StatusElement = document.getElementById('qStatus');
            window.s3StatusElement = document.getElementById('cStatus');
            window.hStatusElement = document.getElementById('hStatus');
            window.aStatusElement = document.getElementById('aStatus');
            
            // Buttons
            window.recordBtn = document.getElementById('recordBtn');
            window.pitchRecordBtn = document.getElementById('pitchRecordBtn');
            window.answerBtn = document.getElementById('answerBtn');
            window.closeBtn = document.getElementById('closeBtn');
            window.replyBtn = document.getElementById('replyBtn');
            window.answerHBtn = document.getElementById('answerHBtn');
            window.answerABtn = document.getElementById('answerABtn');
            window.finalSaveBtn = document.getElementById('finalSaveBtn');
            
            // Next Buttons
            document.getElementById('nextRoundBtn').onclick = () => { hideAllSec(); document.getElementById('section1_5Div').style.display='block'; window.pitchRecordBtn.disabled=false; };
            document.getElementById('nextSection2Btn').onclick = () => { hideAllSec(); document.getElementById('section2Div').style.display='block'; window.startQBtn.disabled=false; qRound=0; };
            document.getElementById('nextSection3Btn').onclick = () => { hideAllSec(); document.getElementById('section3Div').style.display='block'; window.closeBtn.disabled=false; cRound=0; };
            document.getElementById('nextSection4Btn').onclick = window.initSection4;
            document.getElementById('nextSection5Btn').onclick = window.initSection5;

            // FollowUp Button (Create Dynamic)
            window.followUpQBtn = document.createElement('button');
            window.followUpQBtn.textContent = "üéôÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
            window.followUpQBtn.style.display='none';
            window.followUpQBtn.style.backgroundColor='#28a745'; window.followUpQBtn.style.color='white';
            window.followUpQBtn.style.margin='10px'; window.followUpQBtn.style.padding='12px 24px'; window.followUpQBtn.style.border='none'; window.followUpQBtn.style.borderRadius='8px';
            document.getElementById('answerHBtn').parentNode.insertBefore(window.followUpQBtn, document.getElementById('nextSection5Btn'));

            // Listeners
            document.getElementById('startTestBtn').onclick = startTest;
            document.getElementById('finalSaveBtn').onclick = saveAllRecordings;
            window.inputUserName = document.getElementById('inputUserName');
            window.inputUserGroup = document.getElementById('inputUserGroup');

            // üö® NEW: Auto-Start Logic
            const storedUser = localStorage.getItem('roleplayUserData');
            const storedProd = localStorage.getItem('roleplaySelectedProduct');

            if(await fetchInitialData()) {
                if(storedUser && storedProd === 'health') {
                    const u = JSON.parse(storedUser);
                    window.inputUserName.value = u.fullName;
                    // Try to map department
                    const opts = Array.from(window.inputUserGroup.options).map(o=>o.value);
                    if(opts.includes(u.department)) window.inputUserGroup.value = u.department;
                    else window.inputUserGroup.selectedIndex = 1;

                    console.log("Auto-starting Health test...");
                    setTimeout(() => startTest(), 500);
                }
            }
        };
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
